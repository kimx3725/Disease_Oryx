---
title: "7d.real_long_short_dat_HMM"
author: "Dennis Kim"
date: "2024-01-22"
output: html_document
---

# Document Preamble 
```{r preamble, message=FALSE, warning=FALSE}
# load libraries
library(knitr)
library(dplyr)
library(readr)
library(data.table)
library(here)
library(stringr)
library(tidyr)
library(purrr)
library(lubridate)
library(scales)

# call environmental data
library(terra)

# analysis
library(momentuHMM)
library(adehabitatLT)

# visualization 
library(ggplot2)

options(width = 150)
```

## 1.1. Format of tracking data

Read in the prep data
```{r read in prep data}
# Location data of the oryx 
whole_df <- readr::read_rds(here::here("data/HMM", "HMM_prep_data.Rdata"))
n_oryx <- read_rds(here::here("data/ssf_data", "n_ssf_oryx.rds"))
u_oryx <- read_rds(here::here("data/ssf_data", "u_ssf_oryx.rds"))
i_oryx <- read_rds(here::here("data/ssf_data", "i_ssf_oryx.rds"))

# convert the shrub cover values to percentage 
whole_df <- whole_df %>% mutate(per_shrub = (shrub/100))

# create bern body condition index - if optimal or over = 0, else under = 1
#whole_df <- whole_df %>% mutate(BC = ifelse(c_avg_BC == "under", 1, 0))

# non-infecetd list 
n_list <- unique(n_oryx$ID)

# unknown and infected list 
u_i_oryx <- rbind(u_oryx, i_oryx)
u_i_list <- unique(u_i_oryx$ID)

# filter by unknown and infected list 
u_i_prep <- whole_df %>% filter(ID %in% u_i_list)
n_prep <- whole_df %>% filter(ID %in% n_list)

rm(u_i_oryx, u_i_list, n_list,  whole_df, i_oryx, u_oryx, n_oryx) # remove the unnecessary dataset

# make sure each individual start with the state from 0 
u_i_prep <- u_i_prep %>% 
  group_by(ID) %>% # grouping by ID
  mutate(row_number = row_number()) %>% # adding a row number for each group 
  mutate(infection = ifelse(row_number <= 24, 0, infection)) %>% # assigning value 0 to the first 10 rows per group
  dplyr::select(- c(row_number, shrub, c_avg_BC)) %>% # un-select the row_number column
  ungroup(ID)

u_i_prep <- data.frame(u_i_prep) # convert it to the dataframe

# set infection status for the non-infected as 0 
n_prep <- n_prep %>% mutate(infection = 0) %>% dplyr::select(- c(shrub, c_avg_BC))
n_prep

# bind two data into hmm prep_dat
hmm_prep_dat <- rbind(n_prep, u_i_prep)

rm(n_prep, u_i_prep)
```

prepare data for HMM format
```{r HMM formats}
# prepare data for HMM (compute step lengths and turning angles)
data_hmm <- momentuHMM::prepData(hmm_prep_dat, type = "UTM")

# check the hmm dataset
head(data_hmm, 10)
```

subset the data by long vs short step lengths
```{r step data}
# mean step length per id greather than 500m sl - consider long step 
long_dist_id <- data_hmm %>% 
  group_by(ID) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE)) %>% 
  filter(step_mean > 500) %>% 
  dplyr::select(ID)

long_dist_dat_hmm <- data_hmm %>% filter(ID %in% long_dist_id$ID)


# short step 
short_dist_id <- data_hmm %>% 
  group_by(ID) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE)) %>% 
  filter(step_mean < 500) %>% 
  dplyr::select(ID)

short_dist_dat_hmm <- data_hmm %>% filter(ID %in% short_dist_id$ID)

rm(long_dist_id, short_dist_id)
```

# model fitting - a 4-state HMM

Choose some hypothesised mean step length for each state by looking at the empirical distribution. 
```{r paramter values}
# look at the step lengths distribution
ggplot(long_dist_dat_hmm, aes(x = step))+
  geom_histogram(col = "white", fill = "grey", bins = 20)+
  facet_wrap(~infection, scales = "free")

ggplot(short_dist_dat_hmm, aes(x = step))+
  geom_histogram(col = "white", fill = "grey", bins = 20)+
  facet_wrap(~infection, scales = "free")
```

# infection movement parameters
get the initial movement parameters 
```{r movement params}
# long_dist
long_dist_dat_hmm %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))

# short_dist
short_dist_dat_hmm %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))
```

# initital parameters 
```{r initial parameters}
# Initial parameters
# (step mean for state 1, step mean for state 2, step mean for state N so on... same for step SD s1, step SD s2) and (angle concentration s1, angle concentration s2)

# long_dist
Par0_4s_long <- list(step = c(650, 100, 350, 100,
                              650, 100, 350, 100), 
                     angle = c(0.02, 0.3, 0.01, 0.3))

# short_dist
Par0_4s_short <- list(step = c(365, 100, 250, 100,
                               365, 100, 250, 100), 
                      angle = c(0.002, 0.03, 0.007, 0.03))
```


# infected individual fit
```{r infected}
### Set up model

# number of states 
nbStates <- 4

# label states
stateNames <- c('1' = 'NE', '2' = 'NR', '3' = 'IE', '4' = 'IR')

# Observation distributions (step lengths, turning angles)
dist <- list(step = "gamma", 
             angle = "vm")

# constrain transition probabilities - fix the transition probability matrix to prevent some of the transitions - we set to NA the columns of unconstrained transition probabilities, and we again fix the intercept of the other columns to a large negative number (here -1e6) to set the corresponding transition probabilities to be virtually zero (i.e., impossible transition).
fixbeta <-  matrix(c(NA, -1e6, -1e6,
                     NA, -1e6, NA,
                     -1e6, -1e6, NA,
                     -1e6, -1e6, NA), 
                   nrow = 1, 
                   byrow = TRUE)

# fix initial values 
fixPar <- list(beta = fixbeta)
```

# unknown movement models
```{r unknown}
# Fit a 4-state HMM

# long_dist
hmm_long <- momentuHMM::fitHMM(long_dist_dat_hmm, 
                          nbStates = nbStates, 
                          fixPar = fixPar,
                          dist = dist, 
                          Par0 = Par0_4s_long,
                          stateNames = stateNames)

# short_dist
hmm_short <- momentuHMM::fitHMM(short_dist_dat_hmm, 
                          nbStates = nbStates, 
                          fixPar = fixPar,
                          dist = dist, 
                          Par0 = Par0_4s_short,
                          stateNames = stateNames)
```

model visualization - hmm
```{r hmm model output}
# long_dist
hmm_long

# short_dist
hmm_short
```

```{r hmm visualization}
# Plot estimated distributions and state-coloured tracks

# long-dist
plot(hmm_long, breaks = 25, ask = FALSE)

# short_dist
plot(hmm_short, breaks = 25, ask = FALSE)
```

save the plots as a pdf
```{r example, echo=FALSE, results='hide'}
pdf("real_long_short_HMM_Oryx.pdf")
plot(hmm_long, breaks = 25, ask = FALSE)
plot(hmm_short, breaks = 25, ask = FALSE)
dev.off()
```

# estimated step length visauzliation 
```{r estimated long sl}
colours.states <- c("#F8766D", "#56B4E9", "#009E73", "#E69F00")

x <- seq(0, 1000, length=1000)

meanNE <- hmm_long$mle$step[1,1]
sdNE <- hmm_long$mle$step[2,1] 

meanNR <- hmm_long$mle$step[1,2]
sdNR <- hmm_long$mle$step[2,2]  

meanIE <- hmm_long$mle$step[1,3]
sdIE <- hmm_long$mle$step[2,3]  

meanIR <- hmm_long$mle$step[1,4] 
sdIR <- hmm_long$mle$step[2,4]   

sh <- function(mean, sd) { return(mean^2 / sd^2) }
sc <- function(mean, sd) { return(sd^2 / mean) }

y_NE <- dgamma(x, shape = sh(meanNE,sdNE), scale = sc(meanNE,sdNE))
y_NR <- dgamma(x, shape = sh(meanNR,sdNR), scale = sc(meanNR,sdNR))
y_IE <- dgamma(x, shape = sh(meanIE,sdIE), scale = sc(meanIE,sdIE))
y_IR <- dgamma(x, shape = sh(meanIR,sdIR), scale = sc(meanIR,sdIR))

# combine densities in a single dataframe for more convenient plotting
df.y_NE <- data.frame(dens=y_NE, state="NE", x=x)
df.y_NR <- data.frame(dens=y_NR,  state="NR", x=x)
df.y_IE <- data.frame(dens=y_IE,  state="IE", x=x)
df.y_IR <- data.frame(dens=y_IR,  state="IR", x=x)

cmb <- rbind(df.y_NE, df.y_NR, df.y_IE, df.y_IR)

# reorder factor levels so "total" appears bottom of the legend
cmb$state <- factor(cmb$state, levels = c("NE", "NR", "IE", "IR"))

#cmb <- cmb %>%
  #filter_all(all_vars(is.finite(.)))

# plot distributions
ggplot() +
  geom_line(data=cmb,aes(x=x,y=dens,colour=state,linetype=state), size=1) +
  scale_colour_manual(values=c(colours.states,"#000000")) +
  scale_linetype_manual(values=c("solid","solid","solid","solid")) +
  #scale_y_continuous(limits=c(0,0.005)) +
  #scale_x_continuous(limits=c(0,100)) +
  theme_minimal() +
  theme(legend.title = element_blank()) +
  ylab("density") +
  xlab("step")+
  ggtitle("long-distance fitted only HMM")
```

```{r estimated short sl}
colours.states <- c("#F8766D", "#56B4E9", "#009E73", "#E69F00")

x <- seq(0, 1000, length=1000)

meanNE <- hmm_short$mle$step[1,1]
sdNE <- hmm_short$mle$step[2,1] 

meanNR <- hmm_short$mle$step[1,2]
sdNR <- hmm_short$mle$step[2,2]  

meanIE <- hmm_short$mle$step[1,3]
sdIE <- hmm_short$mle$step[2,3]  

meanIR <- hmm_short$mle$step[1,4] 
sdIR <- hmm_short$mle$step[2,4]   

sh <- function(mean, sd) { return(mean^2 / sd^2) }
sc <- function(mean, sd) { return(sd^2 / mean) }

y_NE <- dgamma(x, shape = sh(meanNE,sdNE), scale = sc(meanNE,sdNE))
y_NR <- dgamma(x, shape = sh(meanNR,sdNR), scale = sc(meanNR,sdNR))
y_IE <- dgamma(x, shape = sh(meanIE,sdIE), scale = sc(meanIE,sdIE))
y_IR <- dgamma(x, shape = sh(meanIR,sdIR), scale = sc(meanIR,sdIR))

# combine densities in a single dataframe for more convenient plotting
df.y_NE <- data.frame(dens=y_NE, state="NE", x=x)
df.y_NR <- data.frame(dens=y_NR,  state="NR", x=x)
df.y_IE <- data.frame(dens=y_IE,  state="IE", x=x)
df.y_IR <- data.frame(dens=y_IR,  state="IR", x=x)

cmb <- rbind(df.y_NE, df.y_NR, df.y_IE, df.y_IR)

# reorder factor levels so "total" appears bottom of the legend
cmb$state <- factor(cmb$state, levels = c("NE", "NR", "IE", "IR"))

#cmb <- cmb %>%
  #filter_all(all_vars(is.finite(.)))

# plot distributions
ggplot() +
  geom_line(data=cmb,aes(x=x,y=dens,colour=state,linetype=state), size=1) +
  scale_colour_manual(values=c(colours.states,"#000000")) +
  scale_linetype_manual(values=c("solid","solid","solid","solid")) +
  #scale_y_continuous(limits=c(0,0.005)) +
  #scale_x_continuous(limits=c(0,100)) +
  theme_minimal() +
  theme(legend.title = element_blank()) +
  ylab("density") +
  xlab("step")+
  ggtitle("short-distance fitted only HMM")
```

# Footer
```{r footer}
sessionInfo()
```