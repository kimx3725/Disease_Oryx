---
title: "6.fit_HMM_oryx"
author: "Dennis Kim"
date: "2024-01-22"
output: html_document
---

# Document Preamble 
```{r preamble, message=FALSE, warning=FALSE}
# load libraries
library(knitr)
library(dplyr)
library(readr)
library(data.table)
library(here)
library(stringr)
library(tidyr)
library(purrr)
library(lubridate)
library(scales)
library(forcats)
library(collapse)
library(naniar)

# visualization 
library(ggplot2)
library(patchwork)
library(momentuHMM)

options(width = 150)
```

## 1.1. Format of tracking data

Read in the prep data
```{r read in prep data}
# Location data of the oryx 
whole_df <- readr::read_rds(here::here("data/hmm_sequence_data", "pool_hmm_shrub_sequence_final.rds"))

# only select the columns that we will use 
whole_df <- whole_df %>% dplyr::select("ID", "states", "x", "y", "time", "c_avg_BC")

# change the col name to "state"
names(whole_df)[2] <- "state"

whole_df
```

list of infection stats per id
```{r list of status}
n_oryx <- read_rds(here::here("data/ssf_data", "n_ssf_oryx.rds"))
u_oryx <- read_rds(here::here("data/ssf_data", "u_ssf_oryx.rds"))
i_oryx <- read_rds(here::here("data/ssf_data", "i_ssf_oryx.rds"))

n_list <- unique(n_oryx$ID)
u_list <- unique(u_oryx$ID)
i_list <- unique(i_oryx$ID)

rm(n_oryx, u_oryx, i_oryx)

# create a new ID
whole_df1 <- whole_df %>% mutate(status = ifelse(whole_df$ID %in% i_list, "i", ifelse(whole_df$ID %in% n_list, "n", "u")))

whole_df1$new_ID <- paste(whole_df1$status, whole_df1$ID, sep = "_")
whole_df1 

rm(n_list, u_list, i_list)

whole_df1 %>% as.data.frame() %>% summary()

whole_df1 %>% distinct(ID, status)

whole_df1 %>% distinct(ID, state) %>% filter(state == 5)
```

visualize 
```{r visualization}
fig <- whole_df1 %>% filter(ID %in% c(18, 22, 34, 45))

# new facet label names for dose variable 
id.labs <- c("i_18" = "Infected 18", 
               "i_22" =  "Infected 22", 
               "u_34" =  "Uknown 34", 
               "u_45" =  "Uknown 45")

fig %>% distinct(new_ID)

# same scale 
fig3a <- ggplot(fig, mapping = aes(x, y, col = state, group = new_ID))+
  geom_point(size = 0.7, position=position_jitter(h=0.1, w=0.1))+
  geom_path(size = 0.4)+
  scale_color_manual(values = c("#E69F00", "#0072B2", "#009E73", "#CC79A7", "black"),
                     labels = c("NE", "NR", "IE", "IR", "D"))+
  #coord_equal()+
  facet_wrap(~new_ID,
             labeller = labeller(new_ID = id.labs))+
  theme(panel.border = element_rect(color = "grey", fill = NA, size = 1), 
        panel.background = element_blank(),
        axis.text = element_text(size = 5),
        axis.text.x = element_text(angle=45),
        legend.position = "none"
        )+
  xlab("Longtidue")+
  ylab("Latitude")+
  ggtitle("(a)")

# free scale 
fig3b <- ggplot(fig, mapping = aes(x, y, col = state, group = new_ID))+
  geom_point(size = 0.5, position=position_jitter(h=0.1, w=0.1))+
  geom_path(size = 0.01)+
  scale_color_manual(values = c("#E69F00", "#0072B2", "#009E73", "#CC79A7", "black"),
                     labels = c("NE", "NR", "IE", "IR", "D"))+
  facet_wrap(~new_ID,
             labeller = labeller(new_ID = id.labs),
             scales = "free",
             ncol = 2)+
  theme(panel.border = element_rect(color = "grey", fill = NA, size = 1), 
        panel.background = element_blank(),
        axis.title.y = element_blank(),
        axis.text = element_text(size = 5),
        axis.text.x = element_text(angle=45))+
  xlab("Longtidue")+
  ylab("Latitude")+
  ggtitle("(b)")

fig3a
fig3b
```

combine the plots 
```{r combine the plots}
# combine the figures 
#grid <- cowplot::plot_grid(fig3a, fig3b, nrow = 1, rel_widths = c(1/3,2/3), align = "h")

fig3a | fig3b 
```

save the plot 
```{r save the plot}
pdf("figure4.pdf")
fig3a
fig3b
dev.off()
```

# sequence over time 

visualization to HMM state sequence over time 
```{r state time visualization}
whole_df2 <- whole_df1 %>% mutate(julian = lubridate::yday(time),
                            week = lubridate::week(time)) # create the week column
#hmm_df$states <- as.factor(states) # factorize the state
#hmm_df$ID <- as.numeric(hmm_df$ID) # convert the ID to numeric
#whole_df3 <- whole_df3 %>% arrange(desc(ID)) # rearrange the ID by desc order

whole_df3 <- whole_df2 %>% dplyr::filter(status %in% c("i", "u"))
whole_df3 %>% distinct(ID, state) %>% filter(state == "5")
whole_df3

# relevel the factor
whole_df3$ID <- factor(whole_df3$ID, 
                     levels = c("2", "3", "4", "5", "6", "8", "9", "10", "11", "14", "15", "16", "17", "18", "19", "20", "22", "23", "24", "25", "27", "30", "33", "34", "36", "37", "40", "44", "45"))

#whole_df3$state <- as.numeric(whole_df3$state) 
#whole_df3$c_avg_BC <- as.numeric(whole_df3$c_avg_BC)
whole_df3


# get most frequent values per group 
whole_df4 <- whole_df3 %>% 
  # add a column n with count by categories
  add_count(ID, julian, state, c_avg_BC) %>% 
  # select max or first occurrence by ID 
  group_by(ID, julian) %>% 
  # keep only first TRUE
  mutate(majority_state= state[n == max(n)][1],
         majority_bc = c_avg_BC[n == max(n)][1]) %>% 
  # do not keep temp var 
  dplyr::select(ID, majority_state, majority_bc, julian, time)

# change the column names 
colnames(whole_df4) <- c("ID", "state", "bc", "julian", "time")
whole_df5 <- whole_df4 %>% distinct()
whole_df5
whole_last_n

# last slice list 
whole_last_n <- whole_df3 %>% group_by(ID) %>% summarise_all(last)
colnames(whole_last_n)[6] <- "bc"
whole_last_n

# visualize the trends 
fig4 <- ggplot(whole_df5, aes(x =julian, y = ID))+
        geom_point(stat='identity', aes(color=state, shape = bc), size = 2)+
        #geom_line(stat = 'identity', aes(col=state), size = 1)+
        scale_y_discrete("ID", 
                          labels = as.character(whole_df3$ID), 
                          breaks = whole_df3$ID#, 
                          #expand = expansion(mult = c(0, .02),add = c(1, 0))
                          )+
        scale_color_manual(values = c("#E69F00", "#0072B2", "#009E73", "#CC79A7", "black"),
                            labels = c("NE", "NR", "IE", "IR", "D"))+
        scale_shape_manual(values = c(15, 17),
                           na.value = 16,
                           labels = c("Under", "Optimal")
                          )+
        theme_bw()+
        xlab("julian")

fig4a <- ggplot() +
  geom_point(data = whole_df5, aes(x = julian, y = ID, color = state), size = 2) +
  geom_point(data = whole_last_n, aes(x = julian, y = ID, color = state, shape = bc), size = 2.5) +
  scale_y_discrete("ID", 
                   labels = as.character(whole_df3$ID), 
                   breaks = whole_df3$ID) +
  scale_color_manual(values = c("#E69F00", "#0072B2", "#009E73", "#CC79A7", "black"),
                     labels = c("NE", "NR", "IE", "IR", "D")) +
  scale_shape_manual(values = c(15, 17),
                     na.value = 16,
                     labels = c("Under", "Optimal")) +
  theme_bw() +
  xlab("julian")

fig4

fig4a
```

save the plot 
```{r save the plot}
pdf("figure5.pdf")
fig4a
dev.off()
```

stationary transition probabilities
```{r station transition probabilities}
hmm <- readr::read_rds(here::here("data/hmm_real_outputs", "pool_hmm_shrub_final.rds"))
hmm
```
Another useful output is the plot of the stationary state probabilities as functions of the covariates. They
measure the probability of being in each state in the long run, for a grid of values of the covariate, and can
be displayed with the function plotStationary.
```{r stationary plot}
# Plot estimated distributions and transition probabilities as functions of temperature
plot(hmm, plotTracks = FALSE, ask = FALSE, plotCI = TRUE)

# Plot stationary state probabilities as functions of temperature
plotStationary(hmm, plotCI = TRUE)
```
This plot suggests that the elephants were more likely to be in state 1 at low temperatures, and in state 2
at high temperatures. I donâ€™t know if there is a clear interpretation for this finding in terms of elephant
behaviour.

save the plots as a pdf
```{r example, echo=FALSE, results='hide'}
pdf("pool_HMM_Oryx_shrub_final.pdf")
plot(hmm, plotTracks = FALSE, ask = FALSE, plotCI = TRUE)
dev.off()
```

# Footer
```{r footer}
sessionInfo()
```