---
title: "final_post_amt_data_R01M"
author: "Dennis Kim"
date: "2023-02-10"
output: html_document
---

# Document Preamble 
```{r preamble, message=FALSE, warning=FALSE}
# load libraries
library(knitr)
library(here)
library(tidyverse)
library(lubridate)
library(amt)

options(width = 150)

# set knitr options 
opts_chunk$set(fig.width = 6, fig.height = 5, comment = NA)
```

# Read Data

ssf data
```{r read data}
# read the tracking data: R01M
ssfdat <- read_rds(here::here("data/finalized_data", "multiple_trk_modified.Rdata"))

# only select the lon lat data
ssfdat <- ssfdat %>% dplyr::select(-c("x1_", "x2_", "y1_", "y2_")) %>% rename(., x1_ = coords.x1, y1_ = coords.y1, x2_ = coords.x2, y2_ = coords.y2)
```

# Prepare environmental data
since converting to the amt track with random steps will remove all the other columns of the raw data, we will have to find a way to remerge those potential covariate information. Make sure to go back to the rgee approach to the current data.

Bring all the environmental data 
```{r env data}
# used locations 
use.NDVI <- read_rds(here::here("data/env_data", "Multi_SSF_NDVI_use.Rdata"))
use.PRC <- read_rds(here::here("data/env_data", "Multi_SSF_PRC_use.Rdata"))
use_ssf <- ssfdat %>% filter(case_ == TRUE)

# round by 5 digits 
use_ssf$x1_ <- round(use_ssf$x1_, digits = 5)
use_ssf$y1_ <- round(use_ssf$y1_, digits = 5)

use.NDVI$lon <- round(use.NDVI$lon, digits = 5)
use.NDVI$lat <- round(use.NDVI$lat, digits = 5)

use.PRC$lon <- round(use.PRC$lon, digits = 5)
use.PRC$lat <- round(use.PRC$lat, digits = 5)

# select applicable columns and change the col names to match the ssf data
use.NDVI <- use.NDVI %>% dplyr::select(lon, lat,  Date, id, NDVI) %>% rename_with(.cols = c(1:4), ~c("x1_","y1_","t1_", "masterID"))
use.PRC <- use.PRC %>% dplyr::select(lon, lat, Date, id, total_precipitation) %>% rename_with(.cols = c(1:4), ~c("x1_", "y1_", "t1_","masterID"))

# merge used location 
use.NDVI
use.PRC

ssfdat %>% filter(case_ == TRUE) %>% left_join(use.NDVI, by = c("x1_", "y1_","t1_", "masterID")) %>% summary()
ssfdat %>% filter(case_ == TRUE) %>% left_join(use.PRC, by = c("x1_", "y1_","t1_", "masterID")) %>% summary()


# NDVI
use_ssf <- use_ssf %>% left_join(use.NDVI, by = c("x1_", "y1_","t1_", "masterID"))
# total precipitation
use_ssf <- use_ssf %>% left_join(use.PRC, by = c("x1_", "y1_","t1_", "masterID"))

# rearrange step_id_ by masterID
use_ssf <- use_ssf %>% group_by(masterID) %>% arrange(step_id_) %>% ungroup()

# get rid of the duplicated rows
use_ssf <- use_ssf[!duplicated(use_ssf),]

use_ssf %>% na.omit(NDVI, total_precipitation) %>% summary()
```

```{r random}
# random locations 
random.NDVI <- read_rds(here::here("data/env_data", "Multi_SSF_NDVI_random.Rdata"))
random.PRC <- read_rds(here::here("data/env_data", "Multi_SSF_PRC_random.Rdata"))
random_ssf <- ssfdat %>% filter(case_ == FALSE)

# round by 5 digits 
random_ssf$x2_ <- round(random_ssf$x2_, digits = 5)
random_ssf$y2_ <- round(random_ssf$y2_, digits = 5)

random.NDVI$lon <- round(random.NDVI$lon, digits = 5)
random.NDVI$lat <- round(random.NDVI$lat, digits = 5)

random.PRC$lon <- round(random.PRC$lon, digits = 5)
random.PRC$lat <- round(random.PRC$lat, digits = 5)

random.NDVI <- random.NDVI %>% dplyr::select(lon, lat, t_, id, NDVI) %>% rename_with(.cols = c(1:4), ~c("x2_", "y2_", "t2_","masterID"))
random.PRC <- random.PRC %>% dplyr::select(lon, lat, t_, id, total_precipitation) %>% rename_with(.cols = c(1:4), ~c("x2_", "y2_", "t2_","masterID"))

random.NDVI

random_ssf <- random_ssf %>% left_join(random.NDVI[!duplicated(random.NDVI),], by = c("x2_", "y2_", "t2_", "masterID")) # NDVI
random_ssf <- random_ssf %>% left_join(random.PRC[!duplicated(random.PRC),], by = c("x2_", "y2_", "t2_", "masterID")) # total precipitation

random_ssf %>% na.omit(NDVI, total_precipitation) %>% summary()
```

bind all the observed and random locations together 
```{r bind ssfdat}
# bind the data
final_ssf <- rbind(use_ssf, random_ssf) %>% group_by(masterID) %>% arrange(step_id_) %>% ungroup()
final_ssf
```

# Calculate the speed
```{r speed}
# calculate the speed 
#speed <- final_ssf %>% dplyr::select(masterID, x1_, y1_, t1_) %>%
  #group_by(masterID) %>%
  #make_track(masterID = masterID, x1_, y1_, t1_) %>%
  #ungroup() %>%
  #filter(!duplicated(.)) %>% 
  #nest_by(masterID) %>% 
  #mutate(speed = map(list(data), ~ .x %>% amt::speed())) %>% 
  #unnest() %>% 
  #ungroup() %>% 
  #rename_with(.cols = c(2:4), ~c("x1_", "y1_", "t1_"))
  
#speed

# merge the speed to the ssf R01M 
#final_ssf1 <- final_ssf %>% left_join(speed, by = c("x1_", "y1_", "t1_", "masterID"))
#final_ssf1
```

save the finalized ssf data 
```{r save the finalized data}
#write_rds(final_ssf, path = here("data/finalized_data","finalized_SSF_Multi.Rdata"))
```

# Footer
```{r footer}
sessionInfo()
```