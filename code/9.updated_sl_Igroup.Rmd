---
title: "8.updated_sl_Igroup"
author: "Dennis Kim"
date: "2023-07-20"
output: html_document
---
# Document Preamble 
```{r preamble, message=FALSE, warning=FALSE}
# load libraries
library(knitr)
library(here)
library(tidyverse)
library(lubridate)
library(amt)
library(ggplot2)
library(broom)
library(jtools)
library(huxtable)
library(cowplot)
library(glmmTMB)
library(circular)
library(raster)
library(terra)
library(sp)
library(sf)
library(ggthemes)
library(weathermetrics)
options(width = 150)

# set knitr options 
opts_chunk$set(fig.width = 6, fig.height = 5, comment = NA)
```

# Read amt trk Data

Tracking amt trk data
```{r trk data}
# read the tracking data: R01M
ssfdat <- read_rds(here::here("data/finalized_data", "finalize_ssfdat.Rdata"))
summary(ssfdat)
```

data clean
```{r data clean}
# filter out the inifinite values 
ssfdat <- ssfdat %>% filter_all(all_vars(!is.infinite(.)))

# relevel the reference base category
ssfdat$fate <- fct_relevel(ssfdat$fate, "Non_infected")
ssfdat$infected <- fct_relevel(ssfdat$infected, "pre")

# arrange by step_id per masterID 
ssfdat <- ssfdat %>% group_by(masterID) %>% arrange("step_id") %>% ungroup(masterID)

# logical status 
ssfdat$case_ <- as.logical(ssfdat$case_)

# check the data per group id 
ssfdat %>% group_by(masterID) %>% tally()

# remove the individuals that has less than 2,000 data points 
ssfdat <- ssfdat %>% filter(masterID != "B47_G1289M")

# only select the infected ones 
infected_ssfdat <- ssfdat %>% filter(fate == "Infected")

# scale continuous variables
infected_ssfdat$temp_c <- weathermetrics::kelvin.to.celsius(infected_ssfdat$temp)

# filter out the step length < 5000
infected_ssfdat <- infected_ssfdat %>% dplyr::filter(sl_ < 5000)

# scale the covariates 
infected_ssfdat$NDVI <- scale(infected_ssfdat$NDVI)

# check the number of rows per id
infected_ssfdat %>% group_by(masterID) %>% tally()

# convert the dt_ in seconds units 
infected_ssfdat <- infected_ssfdat %>% mutate(dt_ = lubridate::seconds(dt_)*60)

# calculate the speed
infected_ssfdat <- infected_ssfdat %>% group_by(masterID) %>% mutate(speed = ((sl_))/as.numeric(dt_)) %>% ungroup()

# summary of the dataset
summary(infected_ssfdat)
```

Visualize the histogram of the step lengths between pre and active infection status among infecteds 
```{r infected}
ggplot(infected_ssfdat, aes(x = sl_))+
  geom_histogram()+
  facet_wrap(~infected)

ggplot(infected_ssfdat, aes(x = speed))+
  geom_histogram()+
  facet_wrap(~infected)+
  xlim(0,1)
```

filter the data by infection periods 
```{r filter data}
# pre infection periods 
pre_ssfdat <- infected_ssfdat %>% filter(infected == "pre")
pre_ssfdat %>% group_by(masterID) %>% tally()

# post infection periods 
post_ssfdat <- infected_ssfdat %>% filter(infected == "active")
post_ssfdat %>% group_by(masterID) %>% tally()
```


# Movement Characteristics updates 
individual fits with infection status 

initially, random steps are generated by fitting a tentative gamma distribution to the observed step lengths and a tentativie von Mises distribution to the observed turn angles. It then generates random available points by sampling step-lengths and turn angles from these fitted distributions and combining these random steps with the starting locations associated with each observed movement step.

Now we will adjust these tentative estimates of parameters for the influence of habitat selection. (sl_, log_sl_, and cos_ta_) describe selection-free movement distributions. We include these parameters to update the scale and shape paramters of our tentative distributions -- we will fit iSSF for each individual.

Pre infection periods
```{r pre fits}
# dataframe for s1 
s1 <- data.frame(final.shrub = seq(from = 0, to = 17, length.out = 100),
                 temp_c = 25.28,
                 NDVI = 0,
                 c_avg_BC = factor("under", levels = levels(pre_ssfdat$c_avg_BC)),
                 sl_ = 300,
                 log_sl_ = 4,
                 cos_ta_ = 0.1
)


# dataframe for s2
s2 <- data.frame(final.shrub = 7,
                 temp_c = 25.28,
                 NDVI = 0,
                 c_avg_BC = factor("under", levels = levels(pre_ssfdat$c_avg_BC)),
                 sl_ = 300,
                 log_sl_ = 4,
                 cos_ta_ = 0.1
)

# Individual model fitting in amt 
ind_id <- unique(pre_ssfdat$masterID) # id indicators 
sl_df <- data.frame(ind_id) # creating a data frame for sl updates 
pre_fit.list <- list() # create an empty list for storing the fitted values 
pre_log_rss.list <- list() # create an empty list for storing the log rss values 
p <- ggplot()

# for-loop
for(i in 1:length(ind_id)){
  ind_temp <-subset(pre_ssfdat, masterID == ind_id[i]) # subset the original data by id and store 

# model fitting - store 
  pre_fit.list[[i]] <- pre_ssfdat %>% filter(masterID == ind_id[i]) %>%
    fit_issf(
      case_ ~ sl_ + log_sl_ + cos_ta_ + NDVI + final.shrub + temp_c +
          # interaction term
          NDVI:(c_avg_BC) +   final.shrub:(c_avg_BC) + temp_c:(c_avg_BC) +
          # interaction term
          sl_:(c_avg_BC)+ log_sl_:(c_avg_BC)+
          strata(step_id_), model = TRUE
    )
  
# calculate log-RSS 
  pre_log_rss.list[[i]] <- log_rss(pre_fit.list[[i]], s1, s2)
  
  pre_log_rss.list[[i]] <- pre_log_rss.list[[i]]$df
  
  pre_log_rss.list[[i]]$id <- ind_id[i]

}

# rbind all the log_rss list
pre_log_rss <- do.call(rbind, pre_log_rss.list)  

pre_log_rss

# plot 
pre.plot <- p + geom_line(data= pre_log_rss, aes(x = final.shrub_x1, y = log_rss, fill = factor(id)), 
                   size = 1, alpha =0.2)+
  geom_smooth(data = pre_log_rss, aes(x = final.shrub_x1, y = log_rss), se = FALSE, alpha = 1, color = "red")+
  labs(x = "Shrub", y = "Log RSS vs Mean shrub", title = "Pre-infection")+
  theme_bw()+
  theme(legend.position = "none")

p + geom_line(data= pre_log_rss, aes(x = final.shrub_x1, y = log_rss, colour = factor(id)))

pre.plot
```

Pre infection periods
```{r post fits}
# dataframe for s3 
s3 <- data.frame(final.shrub = seq(from = 0, to = 17, length.out = 100),
                 temp_c = 25.28,
                 NDVI = 0,
                 c_avg_BC = factor("under", levels = levels(post_ssfdat$c_avg_BC)),
                 sl_ = 300,
                 log_sl_ = 4,
                 cos_ta_ = 0.1
)


# dataframe for s2
s4 <- data.frame(final.shrub = 7,
                 temp_c = 25.28,
                 NDVI = 0,
                 c_avg_BC = factor("under", levels = levels(post_ssfdat$c_avg_BC)),
                 sl_ = 300,
                 log_sl_ = 4,
                 cos_ta_ = 0.1
)

# Individual model fitting in amt 
ind_id <- unique(post_ssfdat$masterID) # id indicators 
sl_df <- data.frame(ind_id) # creating a data frame for sl updates 
post_fit.list <- list() # create an empty list for storing the fitted values 
post_log_rss.list <- list() # create an empty list for storing the log rss values 
p <- ggplot()

# for-loop
for(i in 1:length(ind_id)){
  ind_temp <-subset(post_ssfdat, masterID == ind_id[i]) # subset the original data by id and store 

# model fitting - store 
  post_fit.list[[i]] <- post_ssfdat %>% filter(masterID == ind_id[i]) %>%
    fit_issf(
     case_ ~ sl_ + log_sl_ + cos_ta_ + NDVI + final.shrub + temp_c +
          # interaction term
          NDVI:(c_avg_BC) +   final.shrub:(c_avg_BC) + temp_c:(c_avg_BC) +
          # interaction term
          sl_:(c_avg_BC)+ log_sl_:(c_avg_BC)+
          strata(step_id_), model = TRUE
    )
  
# calculate log-RSS 
  post_log_rss.list[[i]] <- log_rss(post_fit.list[[i]], s1, s2)
  
  post_log_rss.list[[i]] <- post_log_rss.list[[i]]$df
  
  post_log_rss.list[[i]]$id <- ind_id[i]
}

post_log_rss <- do.call(rbind, post_log_rss.list)  

post_log_rss

# plot 
post.plot <- p + geom_line(data= post_log_rss, aes(x = final.shrub_x1, y = log_rss, fill = factor(id)), 
                   size = 1, alpha =0.2)+
  geom_smooth(data = post_log_rss, aes(x = final.shrub_x1, y = log_rss), se = FALSE, alpha = 1, color = "blue")+
  labs(x = "Shrub", y = "", title = "Post-infection")+
  theme_bw()+
  theme(legend.position = "none")

post.plot
```

```{r plot step length prob distribution}
plot_grid <- plot_grid(pre.plot, post.plot)
plot_grid

# save the plot 
#ggsave("fig4.png", plot_grid, width = 5, height = 3)
```

# Footer
```{r footer}
sessionInfo()
```