---
title: "2.inspect_data"
author: "Dennis Kim"
date: "2022-10-03"
output: html_document
---

# Objective 

To manipulate the merged tracking data with the other addtional columns for SSFs. To do this, I will: 

1. Determine infected individuals and healthy individuals    
3=2. Inspect movement characteristics of individuals 

# Document Preamble 
```{r preamble, message=FALSE, warning=FALSE}
# load libraries
library(knitr)
library(dplyr)
library(readr)
library(data.table)
library(DT)
library(here)
library(stringr)
library(tidyr)
library(purrr)
library(lubridate)
library(amt)
library(ggplot2)
library(raster)
library(sf)
options(width = 150)

# set knitr options 
opts_chunk$set(fig.width = 6, fig.height = 5, comment = NA)
```

# Data download and initial preparation

Read in the gps data and 
```{r read in data}
# Location data of the oryx with additional disease columns 
oryx <- read.csv(here::here("data", "oryx_gps_id.csv"))

# NAs in fate column convert to unkown
oryx$fate[is.na(oryx$fate)] <- "unknown"

# summary of the location data 
summary(oryx)
```

# Multiple Individuals 

Referenced by Katherine Mertes -- select healthy and infected individuals within the same release group (R4)

```{r indicators}
# check the disease individuals -- that are dead - filter individuals that have at least 1000 location points
disease_id <- oryx %>% filter(Rgroup == 4) %>% filter(cause_of_death %in% c("disease", "presumed disease")) %>% nest_by(masterID) %>% mutate(rows = nrow(data)) %>% dplyr::select(-data) %>% filter(rows > 1000) 

disease_id

# same for the susceptible individuals 
susceptible_id <- oryx %>% filter(Rgroup == 4) %>% filter(cause_of_death %in% "alive") %>% nest_by(masterID) %>% mutate(rows = nrow(data)) %>% dplyr::select(-data) %>% filter(rows > 10000)

susceptible_id

# check if the body condition data are available
## read the body condition data 
body_condition <- read.csv(here::here("data", "oryx_individual_field_data_122322.csv"))

# only select the columns that are applicable to the data 
body_condition <- body_condition %>% dplyr::select(datetime, animalID, lat, long, body_condition)

# filter the data with non-NAs for body condition values 
body_condition <- body_condition[complete.cases(body_condition[, 5]),]

# check the available body condition individuals based on Rgroup 
body_condition_id <- body_condition %>% nest_by(animalID) %>% mutate(rows = nrow(data)) %>% dplyr::select(-data) %>% 
  mutate(group = case_when(
    animalID %in% disease_id$masterID ~ "Infected",
    animalID %in% susceptible_id$masterID ~ "Susceptible"
  )) %>% 
  na.omit()

body_condition_id

# save the body_condition id 
#readr::write_rds(body_condition_id, path = here("data/finalized_data", "bc_id.Rdata"))
```


```{r select individuals}
# select R4 group that has the body condition data (30 individuals)
multiple_oryx <-
  oryx %>% filter(
    masterID %in% body_condition_id$animalID
  )

multiple_oryx

# remove the original data to reduce the memory capacity 
rm(oryx)
rm(disease_id)
rm(susceptible_id)
rm(body_condition_id)

# change the time format of the data 
multiple_oryx$date <- multiple_oryx$date <- as.POSIXct(multiple_oryx$date, format = "%Y-%m-%d %H:%M:%S")
multiple_oryx$date_collared <- multiple_oryx$date_collared %>% mdy()
multiple_oryx$date_released <- multiple_oryx$date_released %>% mdy()

# get rid of any missing location values in long, lat, and timestamp 
filter_ids <- multiple_oryx %>% dplyr::select("long", "lat", "date") %>% complete.cases
multiple_oryx <- multiple_oryx %>% filter(., filter_ids == TRUE)

multiple_oryx %>% distinct(cause_of_death)

# create id group columns 
multiple_oryx <- multiple_oryx %>% mutate(Igroup = ifelse(
  cause_of_death %in% "alive",
  "susceptible",
  "infected"
))

multiple_oryx
```

Add shrubs and trees layers 
```{r shrub and trees}
# call the files as a vector of raster files 
#imgs <- list.files("E:/disease_oryx/data/env_data/shrub", "tif$", full.names = TRUE)

# use lapply to create raster objects wrapped in terra::src to create a SpatRasterCollection
#ic <- sprc(lapply(imgs, rast))

# pass the image collection to the mosaic function
#shrub_raster <- terra::mosaic(ic)
#shrub_raster <- raster(shrub_raster) # convert the SpatRasterlayer class to RasterLayer

# save the shrub ratster 
#writeRaster(shrub_raster, filename = "E:/disease_oryx/data/env_data/shrub/final.shrub.tif", format = "GTiff")

# read the saved merged final raster layer 
shrub_raster <- raster("E:/disease_oryx/data/env_data/shrub/final.shrub.tif")
crs(shrub_raster)

# reproject 
shrub_raster1 <- projectRaster(shrub_raster, crs = "+proj=longlat +datum=WGS84")
shrub_raster1

#writeRaster(shrub_raster1, filename = "E:/disease_oryx/data/env_data/shrub/final.shrub1.tif", format = "GTiff")

# plot the shrub raster
plot(shrub_raster1)

# extract the shrub layers 
#multiple_oryx <- cbind(extract(shrub_raster, multiple_oryx[,c("utm_e", "utm_n")], df = T), multiple_oryx) %>% dplyr::select(-ID)

#multiple_oryx
```

# Create tracks in amt

Add a track class to the data and summarize the data 
```{r amt conversion}
# make tracks 
trk <-
  amt::make_track(
    multiple_oryx,
    .x = long,
    .y = lat,
    .t = date,
    masterID = masterID,
    collar_id = collar_ID,
    sex = sex,
    fate = fate,
    date_collared = date_collared,
    date_released = date_released,
    temp_c = temp_c,
    prev_collar_ID = prev_collar_ID,
    date_released = date_released,
    cause_of_death = cause_of_death,
    Igroup = Igroup,
    crs = CRS("+init=epsg:32634")
  ) 

trk

# save the tracking data 
#write_rds(trk, path = here("data","multiple_original_trk.Rdata"))

# calculate day/night from the movement track 
trk$hour <- hour(trk$t_) # calculate the hour
trk$tod <- ifelse(trk$hour < 7 | 19 < trk$hour, "night", "day") # day/night
trk %>% summary()
```

# Movement characteristics

Calculate step lengths and net squared displacements for each individual, then rbind the data back together. 
```{r movement characteristics}
# nest data by id and add columns to each nested column of data (sl and nsd)
trk1 <- trk %>% nest_by(masterID) %>%
  mutate(sl_ = map(list(data), step_lengths),
         nsd = map(list(data), nsd)) %>%
  unnest()

# calculate year, month, week of each observation and append these to the dataset 
trk1 <- trk1 %>% mutate(
  year = year(t_),
  month = month(t_),
  week = week(t_),
  day_of_year = yday(t_)
)
```

## Net-squared displacement over time for each individual 
```{r nsd visualization}
nsd.vis <- ggplot(trk1, aes(x = t_, y = nsd))+ geom_path()+
  facet_wrap(~masterID, scales = "free")+
  ylab("NSD")+
  xlab("Time")+
  ggtitle("Net-squared displacement over time for each individual")

nsd.vis

# save the plot 
#ggsave("nsd.png", nsd.vis, width = 14, height = 11)
```

## Step length distribution by day/night 
```{r sl visualization, message=FALSE, warning=FALSE}
# alive
sl.dnight <- ggplot(trk1, aes(x= tod, y= log(sl_)))+
  geom_boxplot()+ geom_smooth()+
  facet_wrap(~masterID)+
  ylab("Log(SL)")+
  xlab("Time of day")+
  ggtitle("Step Legnths over time of the day")

sl.dnight

# save the plot 
#ggsave("sl_dnight.png", sl.dnight, width = 14, height = 11)
```

# Resample the tracking data and generate the random points 
```{r sampling rate}
# check the sampling rate of individuals - 1 hour 
trk %>% amt::summarize_sampling_rate_many(c("masterID"))

# regularize the steps and generate random steps 
ssfdat <- trk %>% nest_by(masterID) %>% mutate(
  resample = map(
    list(data),
    ~ .x %>% track_resample(rate = hours(1), tolerance = minutes(30)) %>%
      filter_min_n_burst() %>%
      steps_by_burst() %>%
      random_steps() %>% 
      extract_covariates(shrub_raster1)
  )
) %>% dplyr::select(-data) %>% unnest() %>% ungroup()

ssfdat
```

# seasons 
```{r seasons}
# create an indicator column that label the different seasonal ranges
ssfdat1 <- ssfdat %>%
  mutate(
    week = week(t1_),
    day_of_year = yday(t1_),
    season_level = case_when(
      dplyr::between(day_of_year, 72, 191) ~ 'hotdry',
      dplyr::between(day_of_year, 192, 274) ~
        'rainy'
    )
  ) %>%
  mutate(season_level = replace_na(season_level, "cooldry")) %>%
  ungroup()

ssfdat1
```

# body condition 

filter the body condition data for the selected individuals and join the data 
```{r R01M Bc}
# change the column name of the body condition same as the original tracking data 
colnames(body_condition) <- c("t1_", "masterID", "y1_", "x1_", "body_condition")

# select the healthy individuals for our cases 
BC <-
  body_condition %>% filter(
    masterID %in% body_condition_id$animalID
  )

# create julian dates and week id for the BC data
BC <- BC %>%
  mutate(julian = yday(t1_),
         week = week(t1_)) 

# calculate the average body condition value based on each duplicated week
average.week.BC <- BC %>% group_by(masterID, week) %>% 
  mutate(avg.bc = mean(body_condition)) %>% 
  dplyr::select(week, avg.bc) %>% 
  distinct()

average.week.BC

# join the data
ssfdat2 <- ssfdat1 %>% left_join(average.week.BC, by = c("masterID", "week"))
ssfdat2 %>% na.omit(.)

# only select complete data with body condition
comp.trk <- ssfdat2 %>% filter(!is.na(avg.bc)) %>% 
  mutate(c_avg_BC = ifelse(avg.bc < 4, "under", ifelse(avg.bc < 7, "optimal", "over")) %>% as.factor(.))

comp.trk
```

Identify the cutoff period to separate the seasons of animals when they were infected vs susceptible -- visualize the density of body condition trends over time - 200 julian days would be a good threshold period.
```{r season visualization}
season.vis <- ggplot(comp.trk %>% filter(case_ == TRUE)) +
  # hot dry season
  geom_rect(
    aes(linetype = "hotdry"),
    xmin = 72,
    xmax = 191,
    ymin = 0,
    ymax = Inf,
    fill = "purple",
    alpha = 0.3
  ) +
  # rainy
  geom_rect(
    aes(linetype = "rainy"),
    xmin = 192,
    xmax = 274,
    ymin = 0,
    ymax = Inf,
    fill = "blue",
    alpha = 0.3
  ) +
  # cool dry
  geom_rect(
    aes(linetype = "cooldry"),
    xmin = 275,
    xmax = 365,
    ymin = 0,
    ymax = Inf,
    fill = "pink",
    alpha = 0.3
  ) +
  geom_rect(
    aes(linetype = "cooldry"),
    xmin = 0,
    xmax = 71,
    ymin = 0,
    ymax = Inf,
    fill = "pink",
    alpha = 0.3
  ) +
  # density of body condition
  geom_density(aes(day_of_year, fill = c_avg_BC)) +
  # legend modification
  scale_fill_manual(
    values = c(
      "under" = "red",
      "optimal" = "orange",
      "over" = "green"
    ),
    name = "body condition"
  ) +
  scale_linetype_manual(
    values = c(
      "cooldry" = 0,
      "hotdry" = 0,
      "rainy" = 0
    ),
    name = "season",
    guide = guide_legend(override.aes = list(fill = c(
      "purple", "blue", "pink"
    )))
  )+ 
  # group by the master id
  facet_wrap( ~ masterID, scales = "free")

season.vis

# save the plot 
#ggsave("multi_season_plot.png", season.vis, width = 14, height = 11)
```
by looking at the visualization, the lower body codition happens starting from *hot dry* to *rainy* seasons. - let's check if this trend matches with the modeling fits. (check the model fit 3)

# Plotting the step-length distribution 
```{r step length distribution across different body conditions, out.width="800px", fig.cap= "Step-length distribution across different body conditions"}
# season plot
sl.vis <- comp.trk  %>% filter(case_ == TRUE) %>% dplyr::select(masterID, sl_, c_avg_BC) %>%
  ggplot(aes(sl_, col = c_avg_BC)) + geom_density(size = 1) +
  scale_color_manual(
    name = "Average Body Condition",
    values = c("orange", "darkgreen", "red"),
    labels = c("Optimal", "Over", "Under")
  ) +
  labs(x = "Step Length (m)", y = "Probability Density") +
  theme_bw() +
  facet_wrap( ~ masterID)

sl.vis

# save the plot 
#ggsave("SL_plot.png", sl.vis, width = 14, height = 11)
```

# Individual selection for further analysis
Save the selected individuals' track data
```{r save the files}
#write_rds(comp.trk, path = here("data/finalized_data","multiple_trk.Rdata"))
```

## Footer
```{r footer}
sessionInfo()
```