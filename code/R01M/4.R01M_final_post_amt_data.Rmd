---
title: "final_post_amt_data_R01M"
author: "Dennis Kim"
date: "2023-02-10"
output: html_document
---

# Document Preamble 
```{r preamble, message=FALSE, warning=FALSE}
# load libraries
library(knitr)
library(here)
library(tidyverse)
library(lubridate)
library(amt)

options(width = 150)

# set knitr options 
opts_chunk$set(fig.width = 6, fig.height = 5, comment = NA)
```

# Read Data

Tracking data
```{r read data}
# read the tracking data: R01M
ssf_R01M <- read_rds(here::here("data/finalized_data", "trk.ssf_R01M.Rdata"))

ssf_R01M
```

# Prepare environmental data
since converting to the amt track with random steps will remove all the other columns of the raw data, we will have to find a way to remerge those potential covariate information. Make sure to go back to the rgee approach to the current data.

Bring all the environmental data 
```{r env data}
# read env data

# used locations 
use.NDVI <- read_rds(here::here("data/env_data", "SSF_NDVI_use.Rdata"))
use.PRC <- read_rds(here::here("data/env_data", "SSF_PRC_use.Rdata"))

# random locations 
random.NDVI <- read_rds(here::here("data/env_data", "SSF_NDVI_random.Rdata"))
random.PRC <- read_rds(here::here("data/env_data", "SSF_PRC_random.Rdata"))

# select applicable columns and change the col names to match the ssf data
use.NDVI <- use.NDVI %>% dplyr::select(lon, lat, t_, case, NDVI) %>% rename_with(.cols = c(1:4), ~c("x1_", "y1_", "t1_", "case_"))
use.PRC <- use.PRC %>% dplyr::select(lon, lat, t_, case, total_precipitation) %>% rename_with(.cols = c(1:4), ~c("x1_", "y1_", "t1_", "case_"))

random.NDVI <- random.NDVI %>% dplyr::select(lon, lat, t_, case, NDVI) %>% rename_with(.cols = c(1:4), ~c("x2_", "y2_", "t2_", "case_"))
random.PRC <- random.PRC %>% dplyr::select(lon, lat, t_, case, total_precipitation) %>% rename_with(.cols = c(1:4), ~c("x2_", "y2_", "t2_", "case_"))

# change the format case to logic to match the original ssf data 
use.NDVI$case_ <- as.logical(use.NDVI$case_)
use.PRC$case_ <- as.logical(use.PRC$case_)

random.NDVI$case_ <- as.logical(random.NDVI$case_)
random.PRC$case_ <- as.logical(random.PRC$case_)

# merge the R01M data

# used location first
use_ssf_R01M <- ssf_R01M %>% filter(case_ == TRUE) %>% left_join(use.NDVI[!duplicated(use.NDVI[c(1:4)]),], by = c("x1_", "y1_", "t1_", "case_")) # NDVI
use_ssf_R01M <- use_ssf_R01M %>% left_join(use.PRC[!duplicated(use.PRC[c(1:4)]),], by = c("x1_", "y1_", "t1_", "case_")) # total precipitation
use_ssf_R01M

# random location info merge
random.NDVI$x2_ <- format(round(random.NDVI$x2_, 5))
random.NDVI$y2_ <- format(round(random.NDVI$y2_, 5))
random.PRC$x2_ <- format(round(random.PRC$x2_, 5))
random.PRC$y2_ <- format(round(random.PRC$y2_, 5))

ssf_R01M$x2_ <- format(round(ssf_R01M$x2_, 5))
ssf_R01M$y2_ <- format(round(ssf_R01M$y2_, 5))

random_ssf_R01M <- ssf_R01M %>% filter(case_ == FALSE) %>% left_join(random.NDVI[!duplicated(random.NDVI[c(1:4)]),], by = c("x2_", "y2_", "t2_", "case_")) # NDVI

random_ssf_R01M <- random_ssf_R01M %>% left_join(random.PRC[!duplicated(random.PRC[c(1:4)]),], by = c("x2_", "y2_", "t2_", "case_")) # total precipitation

random_ssf_R01M$x2_ <- as.double(random_ssf_R01M$x2_)
random_ssf_R01M$y2_ <- as.double(random_ssf_R01M$y2_)

random_ssf_R01M
```

# Prepare body condition data 

Bring the body condition data
```{r body condition}
# read the body condition data 
body_condition <- read.csv(here::here("data", "oryx_individual_field_data_122322.csv"))

# only select the columns that are applicable to the data 
body_condition <- body_condition %>% dplyr::select(datetime, animalID, lat, long, body_condition)

# filter the data with non-NAs for body condition values 
body_condition <- body_condition[complete.cases(body_condition[, 5]),]

# R01M body condition values
body_condition <- body_condition %>% dplyr::filter(animalID == "R01M")

# change the column name of the body condition same as the original tracking data 
colnames(body_condition) <- c("t1_", "masterID", "y1_", "x1_", "body_condition")

body_condition

# create julian dates and week id for the original data and BC data
final_ssf_R01M <- final_ssf_R01M %>% 
  mutate(julian = yday(t1_),
         week = week(t1_)
         )

body_condition <- body_condition %>% 
  mutate(
          julian = yday(t1_),
          week = week(t1_)
          )

# calculate the average body condition value based on each duplicated week
average.week.BC <- body_condition %>% group_by(week) %>% 
  mutate(avg.bc = mean(body_condition)) %>% 
  dplyr::select(week, avg.bc) %>% 
  distinct()

average.week.BC

# merge the R01M data with weekly average body condition values
final_ssf_R01M <- final_ssf_R01M %>% left_join(average.week.BC, by = c("week"))
```

# Calculate the speed
```{r speed}
# calculate the speed 
speed <- final_ssf_R01M %>% dplyr::select(x1_, y1_, t1_) %>% make_track(x1_, y1_, t1_) %>% filter(!duplicated(.)) %>%  mutate(speed = amt::speed(.)) %>% rename_with(.cols = c(1:3), ~c("x1_", "y1_", "t1_"))

# merge the speed to the ssf R01M 
final_ssf_R01M <- final_ssf_R01M %>% left_join(speed, by = c("x1_", "y1_", "t1_"))
final_ssf_R01M
```

save the finalized ssf data 
```{r save the finalized data}
#write_rds(final_ssf_R01M, path = here("data/finalized_data","finalized_SSF_R01M.Rdata"))
```

# Footer
```{r footer}
sessionInfo()
```