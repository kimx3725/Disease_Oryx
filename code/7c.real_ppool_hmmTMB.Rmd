---
title: "6.fit_HMM_oryx"
author: "Dennis Kim"
date: "2024-01-22"
output: html_document
---

# Document Preamble 
```{r preamble, message=FALSE, warning=FALSE}
# load libraries
library(knitr)
library(dplyr)
library(readr)
library(data.table)
library(here)
library(stringr)
library(tidyr)
library(purrr)
library(lubridate)
library(scales)

# call environmental data
library(terra)
library(adehabitatLT)
library(sf)

# analysis
library(moveHMM)
library(hmmTMB)
library(momentuHMM)

# visualization 
library(ggplot2)

options(width = 150)
```

## 1.1. Format of tracking data

Read in the prep data
```{r read in prep data}
# Location data of the oryx 
whole_df <- readr::read_rds(here::here("data/HMM", "40inds_final_hmm_prep_data.rds"))

# Table of time intervals in data
plot(table(diff(whole_df$time)), xlim = c(0, 300),
xlab = "time interval (min)", ylab = "count")

whole_df
```

prepare data for HMM format
```{r HMM formats}
# prepare data for HMM (compute step lengths and turning angles)
data_hmm <- momentuHMM::prepData(whole_df, type = "UTM")

# factor the ID 
data_hmm$ID <- factor(data_hmm$ID)

# check the hmm dataset
head(data_hmm, 10)

data_hmm <- data_hmm %>% filter(ID == c("11", "18", "22", "36"))
```

# model fitting - a 4-state HMM

# setting up the possible starting movement paramters  
```{r movement params}
# mean movement params
data_hmm %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))
```

# Observation model 
```{r obs model}
# Initial parameters
# step mean for state 1, 2, 3, 4
# turn angle for state 1, 2, 3, 4

Par0_5s <- list(step = list(mean = c(400, 50, 250, 50, 1), 
                            sd = c(400, 50, 250, 50, 1)),
                angle = list(mu = c(0,0,0,0,0), 
                             kappa = c(0.05, 0.2, 0.01, 0.15, 0.001))
                )

# Observation distributions (step lengths, turning angles)
dist <- list(step = "gamma2", 
             angle = "vm")

# create Observation object 
obs <- Observation$new(data = data_hmm,
                       dists = dist,
                       n_states = 5,
                       par = Par0_5s)
```

# Hidden state model 

create a matrix to specify the structure of the model, where each element is the formula for the corresponding transition probability. 
```{r hidden state model}
# Model formulas 
f <- "~s(ID, bs = 're')"

# the diagnoal elements are used as reference for each row, so their formulas are set to ".". 
tpm_structure <- matrix(c(".",    f, "~1", "~1", "~1",
                            f,  ".", "~1",    f, "~1",
                         "~1", "~1",  ".",    f, f,
                         "~1", "~1",    f,  ".", f,
                         "~1", "~1", "~1", "~1", "."),
                        nrow = 5,
                        byrow = TRUE)


# Initial transition probabilites
tpm0 <-  matrix(c(0.7, 0.3, 0, 0, 0,
                  0.2, 0.4, 0, 0.4, 0,
                  0, 0, 0.2, 0.6, 0.2,
                  0, 0, 0.1, 0.5, 0.4,
                  0, 0, 0, 0, 1),
                nrow = 5, 
                byrow = TRUE)

# create MarkovChain object - use the option initial_state = "stationary" to fix the initial distribution of the state process to the stationary distirbution for each time series. 
hid <- MarkovChain$new(n_states = 5,
                       formula = tpm_structure,
                       tpm = tpm0,
                       data = data_hmm,
                       formula = formula)

hid
```

list fixed parameters 
```{r fixed paramters}
# list of fixed parameters 
fixpar <- list(#obs = c("angle.mu.state1.(Intercept)" = NA,
                       #"angle.mu.state2.(Intercept)" = NA,
                       #"angle.mu.state3.(Intercept)" = NA,
                       #"angle.mu.state4.(Intercept)" = NA,
                       #"angle.mu.state5.(Intercept)" = NA),
               hid = c("S1>S3.(Intercept)" = NA,
                       "S1>S4.(Intercept)" = NA,
                       "S1>S5.(Intercept)" = NA,
                       "S2>S3.(Intercept)" = NA,
                       "S2>S5.(Intercept)" = NA,
                       "S3>S1.(Intercept)" = NA,
                       "S3>S2.(Intercept)" = NA,
                       "S4>S1.(Intercept)" = NA,
                       "S4>S2.(Intercept)" = NA,
                       "S5>S1.(Intercept)" = NA,
                       "S5>S2.(Intercept)" = NA,
                       "S5>S3.(Intercept)" = NA,
                       "S5>S4.(Intercept)" = NA
                       ))

# create HMM object 
hmm <- HMM$new(obs = obs, hid = hid, #fixpar = fixpar
               )

hmm
```

# fit the HMM model 
```{r model fit}
# Fit a 5-state HMM
hmm$fit(silent = TRUE)
```

model visualization - hmm
```{r hmm model output}
hmm

# save the hmm output 
saveRDS(hmm, "ppool_hmmTMB.rds")
```

# interpreting the state
```{r hmm visualization}
colours.states <- c("#238b45", "#88419d", "#d7301f", "#0570b0", "black")


hmm$plot_dist("step")+
  scale_colour_manual(name = "States",
                      values = c(colours.states),
                      labels = c("NE", "NR", "IE", "IR", "total"))+
  scale_fill_manual(name = "States",
                    values=c(colours.states), 
                    labels = c("NE", "NR", "IE", "IR", "total"))+
  scale_linetype_manual(name = "States",
                        values=c("solid","solid","solid", "solid","dashed"),
                        labels = c("NE", "NR", "IE", "IR", "D"))+
  coord_cartesian(ylim = c(0, 0.0016))+
  theme(legend.position = c(0.85, 0.75))+
  xlim(0, 5000)+
  labs(x = "step (m)")


hmm$plot_dist("step")
hmm$plot_dist("angle")
```

plot track 
```{r trk plot}
data <- hmm$obs()$data()
state <- as.factor(hmm$states())
ID <- hmm$obs()$data()$ID

df <- data.frame(ID = ID,
                 state = state,
                 x = data$x,
                 y = data$y)

df

# save the hmm output 
#saveRDS(df, "ppool_hmmTMB_sequence.rds")

ggplot(data= df, mapping = aes(x, y, col = state, group = ID))+
  geom_path(size = 0.7)+
  scale_colour_manual(name = "States",
                    values=c(colours.states), 
                    labels = c("NE", "NR", "IE", "IR", "death"))+
  coord_equal()+
  facet_wrap(~ID)
```

# inter-individual heterogeneity 
```{r inter}
ind_delta <- hmm$plot(what = "delta", var = "ID")+
  geom_point(size = 1)+
  scale_colour_manual(name = "States",
                    values=c(colours.states), 
                    labels = c("NE", "NR", "IE", "IR", "total"))+
  scale_fill_manual(name = "States",
                    values=c(colours.states), 
                    labels = c("NE", "NR", "IE", "IR", "total"))

ind_delta
```


save the plots as a pdf
```{r example, echo=FALSE, results='hide'}
pdf("real_hmmTMB_Oryx.pdf")
sl_dist
hmm_sim
ind_delta
dev.off()
```

# Footer
```{r footer}
sessionInfo()
```