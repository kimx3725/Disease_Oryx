---
title: "6.SSF_updated_sl_BC"
author: "Dennis Kim"
date: "2023-07-12"
output: html_document
---

# Document Preamble 
```{r preamble, message=FALSE, warning=FALSE}
# load libraries
library(knitr)
library(here)
library(tidyverse)
library(lubridate)
library(amt)
library(ggplot2)
library(broom)
library(jtools)
library(huxtable)
library(cowplot)
library(glmmTMB)
library(circular)
library(raster)
library(terra)
library(sp)
library(sf)
library(ggthemes)
library(weathermetrics)
options(width = 150)

# set knitr options 
opts_chunk$set(fig.width = 6, fig.height = 5, comment = NA)
```

# Read amt trk Data

Tracking amt trk data
```{r trk data}
# read the tracking data: R01M
ssfdat <- read_rds(here::here("data/finalized_data", "finalize_ssfdat.Rdata"))
ssfdat
```

data clean
```{r data clean}
# filter out the inifinite values 
ssfdat <- ssfdat %>% filter_all(all_vars(!is.infinite(.)))

# get the infection categories
body_condition_id <- read_rds(here::here("data/finalized_data", "bc_id.Rdata"))
body_condition_id_infected <- body_condition_id %>% filter(group == "Infected")

ssfdat <- ssfdat %>% mutate(Igroup = ifelse(
  masterID %in% body_condition_id_infected$animalID,
  "Infected",
  "Susceptible"
))

# relevel the reference base category
ssfdat$c_avg_BC <- fct_relevel(ssfdat$c_avg_BC, "optimal")
ssfdat$Igroup <- fct_relevel(ssfdat$Igroup, "Susceptible")

# remove body condition ids 

# arrange by step_id per masterID 
ssfdat <- ssfdat %>% group_by(masterID) %>% arrange("step_id") %>% ungroup(masterID)

# logical status 
ssfdat$case_ <- as.logical(ssfdat$case_)

# scale continuous variables
ssfdat$temp_c <- weathermetrics::kelvin.to.celsius(ssfdat$temp)

# filter out unrealistic step lengths 
ssfdat <- ssfdat %>% dplyr::filter(sl_ < 5000)

# check the data per group id 
ssfdat %>% group_by(masterID) %>% tally()

# remove the individuals that has less than 2,000 data points 
ssfdat <- ssfdat %>% filter(masterID != "B47_G1289M")

# scale the covariates 
ssfdat$NDVI <- scale(ssfdat$NDVI)

summary(ssfdat)
```

# Movement Characteristics updates 
individual fits with categorical average body condition - movement characteristics updates by the environments 

initially, random steps are generated by fitting a tentative gamma distribution to the observed step lengths and a tentativie von Mises distribution to the observed turn angles. It then generates random available points by sampling step-lengths and turn angles from these fitted distributions and combining these random steps with the starting locations associated with each observed movement step.

Now we will adjust these tentative estimates of parameters for the influence of habitat selection. (sl_, log_sl_, and cos_ta_) describe selection-free movement distributions. We include these parameters to update the scale and shape paramters of our tentative distributions -- we will fit iSSF for each individual.

SL x body conditions
```{r individual fits body conditions}
# Individual model fitting in amt 
ind_id <- unique(ssfdat$masterID) # id indicators 

sl_df <- data.frame(ind_id) # creating a data frame for sl updates 
tmp <- list() # create an empty list for storing the fitted values 


# for-loop
for(i in 1:length(ind_id)){
  ind_temp <-subset(ssfdat, masterID == ind_id[i]) # subset the original data by id and store 
  sl_fit <- amt::fit_distr(ind_temp$sl_[ind_temp$case_ == "TRUE"], "gamma", na.rm=T) # fit tenetative sl distributions
  sl_df[i,2:3]<-sl_fit$params #store all the necessary params 

#sl_df

##model fitting
  ssftemp <- ssfdat %>% filter(masterID == ind_id[i]) %>%
    fit_issf(
     case_ ~ sl_ + log_sl_ + cos_ta_ + NDVI + final.shrub + temp_c +
          # interaction term
          NDVI:(c_avg_BC) +   final.shrub:(c_avg_BC) + temp_c:(c_avg_BC) +
          # interaction term
          sl_:(c_avg_BC) + sl_:(fate) + sl_:(infected)+ log_sl_:(c_avg_BC) + log_sl_:(fate) + log_sl_:(infected)+
          strata(step_id_)
    )
  
  tmp[[i]] <- summary(ssftemp)$coefficients # store the coefficients 
  
  ## Update the step-length distribution
  sl_df[i,4:5] <- update_gamma(dist= sl_fit, 
                               beta_sl = ssftemp$model$coefficients["sl_"],
                               beta_log_sl = ssftemp$model$coefficients["log_sl_"])$params
  
  #step-length distribution for over average body condition
  sl_df[i,6:7] <- update_gamma(dist = sl_fit,
                               beta_sl = ssftemp$model$coefficients["sl_"] + ssftemp$model$coefficients["sl_:c_avg_BCover"],
                               beta_log_sl = ssftemp$model$coefficients["log_sl_"] +  ssftemp$model$coefficients["log_sl_:c_avg_BCover"])$params
  
  #step-length distribution for under average body condition
  sl_df[i,8:9] <- update_gamma(dist = sl_fit,
                               beta_sl = ssftemp$model$coefficients["sl_"] + ssftemp$model$coefficients["sl_:c_avg_BCunder"],
                               beta_log_sl = ssftemp$model$coefficients["log_sl_"] + ssftemp$model$coefficients["log_sl_:c_avg_BCunder"])$params
  
}

coefficients <-do.call(rbind, tmp) # save all the coefficients per id 

# rename the columns of the updated distributions of grouping sl dist
names(sl_df)[4:9] <-c("optimal_shape", "optimal_scale",
                       "over_shape", "over_scale","under_shape", "under_scale") 

sl_df$optimal_mean <- sl_df$optimal_scale*sl_df$optimal_shape
sl_df$over_mean <- sl_df$over_scale*sl_df$over_shape
sl_df$under_mean <- sl_df$under_scale*sl_df$under_shape

head(sl_df)

mean_sl_df <- sl_df %>% dplyr::select(ind_id, over_mean, optimal_mean, under_mean) 
mean_sl_df

#write_rds(sl_df, path = here("data/finalized_data","Updated_sl_dist_BC.Rdata"))
```

Plot the updated mean distributions of the sl per individual 
```{r mean updated sl}
# read rds 
#mean_sl_df <- read_rds(here::here("data/finalized_data", "updated_sl_dist_BC.Rdata"))
mean_sl_df <- mean_sl_df %>% dplyr::select(ind_id, under_mean, optimal_mean, over_mean)

# get the infection categories
body_condition_id <- read_rds(here::here("data/finalized_data", "bc_id.Rdata"))
body_condition_id_infected <- body_condition_id %>% filter(group == "Infected")

# grouping by infection status 
mean_sl_df <- mean_sl_df %>% mutate(Igroup = ifelse(
  ind_id %in% body_condition_id_infected$animalID,
  "Infected",
  "Non_Infected"
))

mean_sl_df 

# from wide to long
mean_sl_df1 <- gather(mean_sl_df, condition, sl_mean, under_mean:over_mean, factor_key = TRUE)
mean_sl_df1$condition <- factor(mean_sl_df1$condition, levels = c("under_mean", "optimal_mean", "over_mean"))

mean_sl_df1 %>% filter(Igroup == "Infected")
```

# visualization
```{r graph}
# across body condition 
updated_sl_mean_plot <-  ggplot(mean_sl_df1, aes(x = condition, y = sl_mean, fill = condition))+
  geom_boxplot()+
  geom_jitter(shape = 16, position = position_jitter(0.2))+
  geom_hline(yintercept = 0, linetype = 2)+
  scale_fill_manual(values = c("#CC79A7", "#009E73", "#E69F00"))+
  scale_x_discrete(labels = c("Under", "Optimal", "Over"))+
  ylab("Mean Step Length (m)")+
  xlab("")+
  theme_bw()+
  theme(legend.position = "none", axis.title.y = element_text(size=10))+
  facet_wrap(~Igroup)

updated_sl_mean_plot

# save the plot 
#ggsave("fig2.png", updated_sl_mean_plot, width = 5, height = 3)
```

# Footer
```{r footer}
sessionInfo()
```
