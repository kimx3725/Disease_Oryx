---
title: "2c.Death_data_prep1"
author: "Dennis Kim"
date: "2023-12-05"
output: html_document
---

# Objective 

To manipulate the merged tracking data with the other addtional columns for SSFs. To do this, I will: 

1. Determine infected individuals and healthy individuals    
3=2. Inspect movement characteristics of individuals 

# Document Preamble 
```{r preamble, message=FALSE, warning=FALSE}
# load libraries
library(knitr)
library(dplyr)
library(readr)
library(data.table)
library(DT)
library(here)
library(stringr)
library(tidyr)
library(purrr)
library(lubridate)

# call environmental data
library(terra)

# analysis
library(hmmSSF)

# visualization 
library(ggplot2)

options(width = 150)

# set knitr options 
opts_chunk$set(fig.width = 6, fig.height = 5, comment = NA)
```

# 1. Data preparation

## 1.1. Format of tracking data

```{r get the reference data}
# Location data of the oryx 
oryx <- readr::read_rds(here::here("data/filtered_dataset", "oryx_trk.Rdata"))

# filter out only rainy season data 
rain_oryx <- oryx %>% filter(season_level == "rainy")

# B15F, R02M, R08M, R12F, R38F
inf_unk_index <- rain_oryx %>% filter(cause_of_death == "Infected" | cause_of_death == "Unknown") %>% distinct(masterID, num_id)

# # fillter out only rainy season data
rain_oryx <- rain_oryx %>% dplyr::select(collar_ID, masterID, Rgroup, num_id)
rain_oryx <- rain_oryx %>% distinct(collar_ID, masterID, Rgroup, num_id)
rain_oryx
```

Read in the gps data
```{r read in data}
# Location data of the oryx with additional disease columns 
oryx_death <- read.csv(here::here("data", "oryx_locs_rainy2018_wDeath_04202024.csv"))
oryx_death <- oryx_death %>% select(collar_ID, WAT, utm_e, utm_n, long, lat)
colnames(oryx_death)[2] <- "date"
oryx_death

oryx_death <- oryx_death %>% filter(collar_ID %in% rain_oryx$collar_ID)
oryx_death <- oryx_death %>% left_join(., rain_oryx, by = "collar_ID")
#oryx_death_info <- oryx_death %>% distinct(masterID, collar_ID, num_id)
#write.csv(oryx_death_info, "Death_data_index.csv")

# summary of the location data 
summary(oryx_death)
```

Referenced by Katherine Mertes -- select healthy and infected individuals within the same release group (R4)
```{r BC indicators}
# check if the body condition data are available
## read the body condition data 
#body_condition <- read.csv(here::here("data", "oryx_individual_field_data_122322.csv"))

# only select the columns that are applicable to the data 
#body_condition <- body_condition %>% dplyr::select(datetime, animalID, lat, long, body_condition)

# filter the data with non-NAs for body condition values 
#body_condition <- body_condition[complete.cases(body_condition[, 5]),]

# check the available body condition individuals based on Rgroup 
#body_condition_id <- body_condition %>% nest_by(animalID) %>% mutate(rows = nrow(data)) %>% dplyr::select(-data) %>% 
#  mutate(group = case_when(
#    animalID %in% oryx_death$masterID ~ "Infected",
#    animalID %in% oryx_death$masterID ~ "Infected",
#    animalID %in% oryx_death$masterID ~ "Susceptible"
#  )) %>% 
#  na.omit()

#body_condition_id 
```

```{r select individuals}
# select R4 group that has the body condition data (52 individuals)
multiple_oryx <- oryx_death 

# remove the original data to reduce the memory capacity 
#rm(oryx)
#rm(disease_id)
#rm(susceptible_id)
#rm(body_condition_id)

# change the time format of the data 
multiple_oryx$date <- multiple_oryx$date <- as.POSIXct(multiple_oryx$date, format = "%Y-%m-%d %H:%M:%S")

# get rid of any missing location values in long, lat, and timestamp 
filter_ids <- multiple_oryx %>% dplyr::select("long", "lat", "date") %>% complete.cases
multiple_oryx <- multiple_oryx %>% filter(., filter_ids == TRUE)

multiple_oryx
```

add seasonal info 
```{r seasons}
# create an indicator column that label the different seasonal ranges
multiple_oryx <- multiple_oryx %>%
  mutate(
    week = week(date),
    day_of_year = yday(date),
    season_level = case_when(
      dplyr::between(day_of_year, 72, 191) ~ 'hotdry',
      dplyr::between(day_of_year, 192, 274) ~
        'rainy'
    )
  ) %>%
  mutate(season_level = replace_na(season_level, "cooldry")) %>%
  ungroup()

multiple_oryx %>% summary()
oryx_df <- multiple_oryx
```

filter the body condition data for the selected individuals and join the data 
```{r Bc}
# change the column name of the body condition same as the original tracking data 
#colnames(body_condition) <- c("date", "masterID", "lat", "long", "body_condition")

# select the healthy individuals for our cases 
#BC <-
#  body_condition %>% filter(
#    masterID %in% body_condition_id$animalID
#  )

# create julian dates and week id for the BC data
#BC <- BC %>%
#  mutate(julian = yday(date),
#         week = week(date)) 

# calculate the average body condition value based on each duplicated week
#average.week.BC <- BC %>% group_by(masterID, week) %>% 
#  mutate(avg.bc = mean(body_condition)) %>% 
#  dplyr::select(week, avg.bc) %>% 
#  distinct()

# join the data
#multiple_oryx2 <- multiple_oryx %>% left_join(average.week.BC, by = c("masterID", "week"))
#multiple_oryx2 %>% na.omit(.)

# only select complete data with body condition
#oryx_df <- multiple_oryx2 %>% filter(!is.na(avg.bc)) %>% 
#  mutate(c_avg_BC = ifelse(avg.bc < 4, "under", ifelse(avg.bc < 7, "optimal", "over")) %>% as.factor(.))

#oryx_df %>% summary()
```

further data cleaning 
```{r data cleaning}
# re-level body conditions and Igroup
#oryx_df <- oryx_df %>% mutate(c_avg_BC = factor(c_avg_BC, level = c("under", "optimal", "over")))

oryx_df

# save the prepared dataset for HMM_SSF
#readr::write_rds(oryx_df, path = here("data/filtered_dataset", "oryx_Death_trk.Rdata"))
```

# Footer
```{r footer}
sessionInfo()
```