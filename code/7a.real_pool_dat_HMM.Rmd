---
title: "7a.real_whole_dat_HMM"
author: "Dennis Kim"
date: "2024-01-22"
output: html_document
---

# Document Preamble 
```{r preamble, message=FALSE, warning=FALSE}
# load libraries
library(knitr)
library(dplyr)
library(readr)
library(data.table)
library(here)
library(stringr)
library(tidyr)
library(purrr)
library(lubridate)
library(scales)

# call environmental data
library(terra)

# analysis
library(momentuHMM)
library(adehabitatLT)

# visualization 
library(ggplot2)

options(width = 150)
```

## 1.1. Format of tracking data

Read in the prep data
```{r read in prep data}
# Location data of the oryx 
whole_df <- readr::read_rds(here::here("data/HMM", "40inds_final_hmm_prep_data.rds"))

plot(table(diff(whole_df$time)), xlim = c(0, 300),
xlab = "time interval (min)", ylab = "count")

whole_df

#whole_df <- whole_df %>% filter(!ID %in% c("13", "21", "26", "29", "39"))
```

prepare data for HMM format
```{r HMM formats}
# prepare data for HMM (compute step lengths and turning angles)
data_hmm <- momentuHMM::prepData(whole_df, type = "UTM")

# check the hmm dataset
head(data_hmm, 10)
```

# model fitting - a 4-state HMM

Choose some hypothesised mean step length for each state by looking at the empirical distribution. 
```{r paramter values}
# look at the step lengths distribution
ggplot(data_hmm, aes(x = step))+
  geom_histogram(col = "white", fill = "grey", bins = 20)+
  facet_wrap(~infection, scales = "free")

# look at the infection distribution
ggplot(data_hmm, aes(x = infection))+
  geom_histogram(col = "white", fill = "grey", bins = 2)
```

get the initial movement parameters 
```{r movement params}
data_hmm %>% 
  filter(!is.na(infection)) %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))
```

```{r 4 dependent parameter values}
### Set up model

# number of states 
nbStates <- 5

# label states
stateNames <- c('1' ="NE", '2' = "NR", '3' = "IE", '4' = "IR", '5' = "D")

# Observation distributions (step lengths, turning angles)
dist <- list(step = "gamma", 
             angle = "vm")

# constrain transition probabilities - fix the transition probability matrix to prevent some of the transitions - we set to NA the columns of unconstrained transition probabilities, and we again fix the intercept of the other columns to a large negative number (here -1e6) to set the corresponding transition probabilities to be virtually zero (i.e., impossible transition).
#1->2 1->3 1->4 1->5
#2->1 2->3 2->4 2->5
#3->1 3->2 3->4 3->5
#4->1 4->2 4->3 4->5
#5->1 5->2 5->3 5->4

fixbeta <-  matrix(c(NA, -1e6, -1e6, -1e6,
                     NA, -1e6, NA, -1e6,
                     -1e6, -1e6, NA, NA,
                     -1e6, -1e6, NA, NA,
                     -1e6, -1e6, -1e6, -1e6), 
                   nrow = 1, 
                   byrow = TRUE)

# fix initial values 
fixPar <- list(beta = fixbeta)

# Initial parameters
# (step mean for state 1, step mean for state 2, step mean for state N so on... same for step SD s1, step SD s2) and (angle concentration s1, angle concentration s2)
Par0_5s <- list(step = c(400, 50, 250, 50, 1,
                         400, 50, 250, 50, 1), 
                angle = c(0.05, 0.1, 0.01, 0.1, 0.001)
                )

# Fit a 4-state HMM
hmm <- momentuHMM::fitHMM(data_hmm, 
                          nbStates = nbStates, 
                          fixPar = fixPar,
                          dist = dist, 
                          Par0 = Par0_5s,
                          stateNames = stateNames)
```

model visualization - hmm
```{r hmm model output}
# Print parameter estimates
hmm

# save the hmm output 
saveRDS(hmm, "pool_hmm.rds")
#hmm <- readr::read_rds(here::here("data/hmm_model_outpus", "whole_hmm.rds"))
```

```{r hmm visualization}
# Plot estimated distributions and state-coloured tracks
plot(hmm, breaks = 20, ask = FALSE)
```

save the plots as a pdf
```{r example, echo=FALSE, results='hide'}
pdf("pool_HMM_Oryx.pdf")
plot(hmm, breaks = 20, ask=FALSE)
dev.off()
```

# estimated whole step length visauzliation 

```{r estimated sl}
colours.states <- c("#F8766D", "#56B4E9", "#009E73", "#E69F00")

x <- seq(0, 1000, length=1000)

meanNE <- hmm$mle$step[1,1]
sdNE <- hmm$mle$step[2,1] 

meanNR <- hmm$mle$step[1,2]
sdNR <- hmm$mle$step[2,2]  

meanIE <- hmm$mle$step[1,3]
sdIE <- hmm$mle$step[2,3]  

meanIR <- hmm$mle$step[1,4] 
sdIR <- hmm$mle$step[2,4]   

sh <- function(mean, sd) { return(mean^2 / sd^2) }
sc <- function(mean, sd) { return(sd^2 / mean) }

y_NE <- dgamma(x, shape = sh(meanNE,sdNE), scale = sc(meanNE,sdNE))
y_NR <- dgamma(x, shape = sh(meanNR,sdNR), scale = sc(meanNR,sdNR))
y_IE <- dgamma(x, shape = sh(meanIE,sdIE), scale = sc(meanIE,sdIE))
y_IR <- dgamma(x, shape = sh(meanIR,sdIR), scale = sc(meanIR,sdIR))

# combine densities in a single dataframe for more convenient plotting
df.y_NE <- data.frame(dens=y_NE, state="NE", x=x)
df.y_NR <- data.frame(dens=y_NR,  state="NR", x=x)
df.y_IE <- data.frame(dens=y_IE,  state="IE", x=x)
df.y_IR <- data.frame(dens=y_IR,  state="IR", x=x)

cmb <- rbind(df.y_NE, df.y_NR, df.y_IE, df.y_IR)

# reorder factor levels so "total" appears bottom of the legend
cmb$state <- factor(cmb$state, levels = c("NE", "NR", "IE", "IR"))

#cmb <- cmb %>%
  #filter_all(all_vars(is.finite(.)))

# plot distributions
ggplot() +
  geom_line(data=cmb,aes(x=x,y=dens,colour=state,linetype=state), size=1) +
  scale_colour_manual(values=c(colours.states,"#000000")) +
  scale_linetype_manual(values=c("solid","solid","solid","solid")) +
  #scale_y_continuous(limits=c(0,0.005)) +
  scale_x_continuous(limits=c(0,100)) +
  theme_minimal() +
  theme(legend.title = element_blank()) +
  ylab("density") +
  xlab("step")
```

take out the estimates from the fitted model HMM 
```{r model outputs}
# bring out the reconstructed most probable states sequence 
states <- momentuHMM::viterbi(hmm)

# add states into hmm
data_hmm$states <- states

data_hmm
```

visualize the state sequence over spatial 
```{r state spatial visualization}
states <- momentuHMM::viterbi(hmm)

data_hmm$states <- states

data_hmm$states <- factor(states, levels = c("1", "2", "3", "4", "5"))

# save the rds file for the state sequences 
saveRDS(data_hmm, "pool_hmm_sequence.rds")

map_1 <- data_hmm %>% filter(ID %in% c(1, 2, 3, 4, 5, 6))


ggplot(map_1, aes(x = x, y = y))+
  geom_path(size = 0.7, aes(color = states))+
  scale_color_manual(values = c("#238b45", "#88419d", "#d7301f", "#0570b0"),
                     labels = c("NE", "NR", "IE", "IR"))+
  coord_equal()+
  facet_wrap(~ID, ncol = 1)
```


visualization to HMM state sequence over time 
```{r state time visualization}
hmm_df <- as.data.frame(data_hmm) # convert it to dataframe 
hmm_df <- hmm_df %>% mutate(julian = yday(time),
                            week = lubridate::week(time)) # create the week column
hmm_df$states <- as.factor(states) # factorize the state
hmm_df$ID <- as.numeric(hmm_df$ID) # convert the ID to numeric
hmm_df <- hmm_df %>% arrange(desc(ID)) # rearrange the ID by desc order
hmm_df_trends <- hmm_df %>% dplyr::select(ID, julian, week, states)

# visualize the trends 
ggplot(hmm_df_trends, aes(x = julian, y = as.factor(ID)))+
       #geom_point(stat='identity', aes(col=states), size = 2)+
       geom_line(stat = 'identity', aes(col=states), size = 1)+
       scale_y_discrete("ID", 
                        labels = as.character(hmm_df$ID), 
                        breaks = hmm_df$ID, 
                        expand = expansion(mult = c(0, .02),add = c(1, 0)))+
       theme_bw()
```

# Footer
```{r footer}
sessionInfo()
```
