---
title: "6.fit_HMM_oryx"
author: "Dennis Kim"
date: "2024-01-22"
output: html_document
---

# Document Preamble 
```{r preamble, message=FALSE, warning=FALSE}
# load libraries
library(knitr)
library(dplyr)
library(readr)
library(data.table)
library(here)
library(stringr)
library(tidyr)
library(purrr)
library(lubridate)
library(scales)

# call environmental data
library(terra)

# analysis
library(momentuHMM)
library(adehabitatLT)

# visualization 
library(ggplot2)

options(width = 150)
```

## 1.1. Format of tracking data

Read in the prep data
```{r read in prep data}
# Location data of the oryx 
whole_df <- readr::read_rds(here::here("data/HMM", "40inds_final_hmm_prep_data.rds"))

# only select infected ones 
n_oryx <- read_rds(here::here("data/ssf_data", "n_ssf_oryx.rds"))

n_list <- n_oryx %>% distinct(ID) %>% arrange(ID)

ninf_df <- whole_df %>% filter(ID %in% n_list$ID)

rm(whole_df)

ninf_df %>% distinct(ID) # 1, 12, 28, 31, 32, 35, 38, 41, 46, 47, 48
```

prepare data for HMM format
```{r HMM formats}
# prepare data for HMM (compute step lengths and turning angles)
data_hmm <- momentuHMM::prepData(ninf_df, type = "UTM")

# check the hmm dataset
head(data_hmm, 10)
```

get the mean step and ta per group 
```{r movement params nf}
# 1, 12, 28, 31, 32, 35, 38, 41, 46, 47, 48

# 1
data_hmm %>% 
  filter(ID == "1") %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))
# 12 
data_hmm %>% 
  filter(ID == "12") %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))
# 28
data_hmm %>% 
  filter(ID == "28") %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))
# 31
data_hmm %>% 
  filter(ID == "31") %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))

# 32
data_hmm %>% 
  filter(ID == "32") %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))
# 35 
data_hmm %>% 
  filter(ID == "35") %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))
# 38
data_hmm %>% 
  filter(ID == "38") %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))
# 41
data_hmm %>% 
  filter(ID == "41") %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))

# 46
data_hmm %>% 
  filter(ID == "46") %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))
# 47 
data_hmm %>% 
  filter(ID == "47") %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))
# 48
data_hmm %>% 
  filter(ID == "48") %>% 
  group_by(infection) %>% 
  dplyr::summarize(step_mean = mean(step, na.rm = TRUE),
                   ta_mean = mean(angle, na.rm = TRUE))
```

# initital parameters per group
```{r init params inf}
# Initial parameters
Par0_5s_list <- list()

# 1, 12, 28, 31, 32, 35, 38, 41, 46, 47, 48

# 1
Par0_5s_list[[1]] <- list(step = c(419, 70, 200, 70, 1,
                                   419, 70, 200, 70, 1), 
                          angle = c(0.04, 0.1, 0.02, 0.1, 0.001))
# 12
Par0_5s_list[[2]] <- list(step = c(443, 70, 200, 70, 1,
                                   443, 70, 200, 70, 1), 
                          angle = c(0.01, 0.1, 0.03, 0.1, 0.001))
# 28
Par0_5s_list[[3]] <- list(step = c(298, 50, 150, 50, 1,
                                   298, 50, 150, 50, 1), 
                          angle = c(0.015, 0.1, 0.01, 0.1, 0.001))
# 31
Par0_5s_list[[4]] <- list(step = c(372, 50, 160, 50, 1,
                                   372, 50, 160, 50, 1), 
                          angle = c(0.002, 0.3, 0.03, 0.3, 0.001))
# 32
Par0_5s_list[[5]] <- list(step = c(604, 100, 300, 100, 1,
                                   604, 100, 300, 100, 1), 
                          angle = c(0.005, 0.3, 0.003, 0.3, 0.001))
# 35
Par0_5s_list[[6]] <- list(step = c(664, 100, 300, 100, 1,
                                   664, 100, 300, 100, 1), 
                          angle = c(0.007, 0.1, 0.002, 0.1, 0.001))
# 38
Par0_5s_list[[7]] <- list(step = c(414, 70, 200, 70, 1,
                                   414, 70, 200, 70, 1), 
                          angle = c(0.02, 0.1, 0.05, 0.1, 0.001))
# 41
Par0_5s_list[[8]] <- list(step = c(464, 70, 220, 70, 1,
                                   464, 70, 220, 70, 1),
                          angle = c(0.05, 0.1, 0.01, 0.1, 0.001))
# 46
Par0_5s_list[[9]] <- list(step = c(535, 80, 250, 80, 1,
                                   535, 80, 250, 80, 1), 
                          angle = c(0.6, 0.8, 0.3, 0.8, 0.001))
# 47
Par0_5s_list[[10]] <- list(step = c(270, 50, 100, 50, 1,
                                    270, 50, 100, 50, 1),
                           angle = c(0.007, 0.3, 0.003, 0.3, 0.001))
# 48
Par0_5s_list[[11]] <- list(step = c(200, 50, 100, 50, 1,
                                    200, 50, 100, 50, 1), 
                           angle = c(0.02, 0.1, 0.04, 0.1, 0.001))
```

# model set up
```{r model set up}
# number of states 
nbStates <- 5

# label states
stateNames <- c('1' = 'NE', '2' = 'NR', '3' = 'IE', '4' = 'IR', '5' = 'D')

# Observation distributions (step lengths, turning angles)
dist <- list(step = "gamma", 
             angle = "vm")

# constrain transition probabilities - fix the transition probability matrix to prevent some of the transitions - we set to NA the columns of unconstrained transition probabilities, and we again fix the intercept of the other columns to a large negative number (here -1e6) to set the corresponding transition probabilities to be virtually zero (i.e., impossible transition).
#1->2 1->3 1->4 1->5
#2->1 2->3 2->4 2->5
#3->1 3->2 3->4 3->5
#4->1 4->2 4->3 4->5
#5->1 5->2 5->3 5->4

fixbeta <-  matrix(c(NA, -1e6, -1e6, -1e6,
                     NA, -1e6, NA, -1e6,
                     -1e6, -1e6, NA, NA,
                     -1e6, -1e6, NA, NA,
                     -1e6, -1e6, -1e6, -1e6), 
                   nrow = 1, 
                   byrow = TRUE)

# fix initial values 
fixPar <- list(beta = fixbeta)
```

# model fit
```{r hmm ni}
# subset the data 
# subset the data 
hmm_n <- data_hmm %>% filter(ID %in% n_list$ID)

# empty list for storing each model fit 
hmm_n_list <- list()

for (id in unique(hmm_n$ID)) {
  id_data <- hmm_n %>% filter(ID == id)
  
  for(j in length(unique(hmm_n$ID))){
  
  hmm_n_list[[id]] <- momentuHMM::fitHMM(id_data,
                                         nbStates = nbStates,
                                         fixPar = fixPar,
                                         dist = dist,
                                         Par0 = Par0_5s_list[[j]],
                                         stateNames = stateNames)
  }
}

#hmm_n_list

# save the hmm output 
saveRDS(hmm_n_list, "npool_n_hmm.rds")
```

get all the state switching info per ind model fit

```{r ninf state switching model fits}
# get the empty list for storing each id states
states_id <- list()

for (i in 1:length(hmm_n_list)) {
  # call each hmm model fit from list per id
  hmm_output <- hmm_n_list[[i]]
  
  # store state swtiching info per each model fit 
  states_id[[i]] <- momentuHMM::viterbi(hmm_output)
}

state_n_dat <- unlist(states_id)

hmm_n$states <- factor(state_n_dat, levels = c("1", "2", "3", "4", "5"))

# save the rds file for the state sequences 
saveRDS(hmm_n, "npool_n_hmm_sequence.rds")
```

combine the whole data together
```{r hmm visualization}
hmm_individual_df <- rbind(hmm_n, hmm_u, hmm_i)

hmm_individual_df

#save the rds file for the state sequences 
saveRDS(hmm_individual_df, "npool_hmm_sequence.rds")
```

# Footer
```{r footer}
sessionInfo()
```