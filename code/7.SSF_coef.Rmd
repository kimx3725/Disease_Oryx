---
title: "R01M_SSF"
author: "Dennis Kim"
date: "2023-02-13"
output: html_document
---

# Document Preamble 
```{r preamble, message=FALSE, warning=FALSE}
# load libraries
library(knitr)
library(here)
library(tidyverse)
library(lubridate)
library(amt)
library(ggplot2)
library(broom)
library(jtools)
library(huxtable)
library(cowplot)
library(circular)
library(raster)
library(terra)
library(sp)
library(sf)
library(ggthemes)
library(standardize)
library(weathermetrics)
library(glmmTMB)
library(modelsummary)
options(width = 150)

# set knitr options 
opts_chunk$set(fig.width = 6, fig.height = 5, comment = NA)
```

# Read amt trk Data

Tracking amt trk data
```{r trk data}
# read the tracking data
ssfdat <- read_rds(here::here("data/finalized_data", "finalize_ssfdat.Rdata"))

# get the infection categories
body_condition_id <- read_rds(here::here("data/finalized_data", "bc_id.Rdata"))
body_condition_id_infected <- body_condition_id %>% filter(group == "Infected")

# convert the temperature 
ssfdat$temp_c <- weathermetrics::kelvin.to.celsius(ssfdat$temp)

# filter out unrealistic step lengths 
ssfdat <- ssfdat %>% dplyr::filter(sl_ < 5000)

# check the data per group id 
ssfdat %>% group_by(masterID) %>% tally()

# remove the individuals that has less than 2,000 data points 
ssfdat <- ssfdat %>% filter(masterID != "B47_G1289M")

# scale the covariates 
ssfdat$NDVI <- scale(ssfdat$NDVI)

summary(ssfdat)
```

# Fitting iSSF model 

## individual model fit 

Considering the enviornmental covariates, NDVI may represent the plant growths than other similar metrics: fPAR, LAI, GPP - Thus, we only include NDVI for the resource yield covariate.
```{r ssf model fit 1}
# fit the issf models per individual
ssffits <- ssfdat %>%
  nest_by(masterID) %>%
  mutate(mod = map(list(data), function(x)
    (
      fit_issf(
        case_ ~ sl_ + log_sl_ + cos_ta_ + NDVI + final.shrub + temp_c +
          # interaction term
          NDVI:(c_avg_BC) +   final.shrub:(c_avg_BC) + temp_c:(c_avg_BC) +
          # interaction term
          sl_:(c_avg_BC) + sl_:(fate) + sl_:(infected)+ log_sl_:(c_avg_BC) + log_sl_:(fate) + log_sl_:(infected)+
          strata(step_id_),
        data = x
      )
    )))

# summarize fits to individual animals 
ssffits <- ssffits %>% mutate(tidy = map(list(mod), ~broom::tidy(.x$model)),
                              n = map_int(list(data), nrow))

# keep just coefficients for comparisons 
ssf_coefs <- ssffits %>% unnest(tidy) %>% filter(term!= "(Intercept)")
ssf_coefs <- ssf_coefs %>% dplyr::select(c(masterID, n, term, estimate, std.error, p.value))

# get the infection categories
ssf_coefs <- ssf_coefs %>% mutate(Igroup = ifelse(
  masterID %in% body_condition_id_infected$animalID,
  "Infected",
  "Susceptible"
))

ssf_coefs

# save the coefficient data frame 
#write_rds(ssf_coefs, path = here("data/finalized_data", "model_coefficients.Rdata"))
```

```{r NDVI}
#NDVI
ndvi.plot <- ssf_coefs %>% filter(!is.na(estimate)) %>%
  filter(term %in% c("NDVI")) %>% 
  ggplot(., aes(x = term, y = estimate, fill = Igroup))+
  geom_boxplot()+
  geom_jitter(shape = 16, position = position_jitter(0.2))+
  geom_hline(yintercept = 0)+
  scale_x_discrete(labels = c("")) +
  ylab("Coefficient estimate") +
  xlab("")+
  ggtitle("Use of NDVI")+
  theme_bw() +
  theme(legend.position = "none") +
  facet_wrap( ~ Igroup)

ndvi.plot

ssf_coefs %>% dplyr::filter(term == "NDVI" & p.value < 0.05)

# save the plot 
ggsave("ndvi_plot.png", ndvi.plot, width = 5, height = 3)
```
The infected individuals selected more of NDVI.

```{r temp}
# temperature
temp.plot <- ssf_coefs %>% filter(!is.na(estimate)) %>%
  filter(term %in% c("temp_c")) %>% 
  ggplot(., aes(x = term, y = estimate, fill = Igroup))+
  geom_boxplot()+
  geom_jitter(shape = 16, position = position_jitter(0.2))+
  geom_hline(yintercept = 0)+
  scale_x_discrete(labels = c("")) +
  ylab("Coefficient estimate") +
  xlab("")+
  ggtitle("Temperature")+
  theme_bw() +
  theme(legend.position = "none") +
  facet_wrap( ~ Igroup)

temp.plot

# save the plot 
ggsave("temp_plot.png", temp.plot, width = 5, height = 3)
```

```{r fpar}
# fpar
fpar.plot <- ssf_coefs %>% filter(!is.na(estimate)) %>%
  filter(term %in% c("fpar")) %>% 
  ggplot(., aes(x = term, y = estimate, fill = Igroup))+
  geom_boxplot()+
  geom_jitter(shape = 16, position = position_jitter(0.2))+
  geom_hline(yintercept = 0)+
  scale_x_discrete(labels = c("")) +
  ylab("Coefficient estimate") +
  xlab("")+
  ggtitle("A fraction of photosynthetically active radiation (fpar)")+
  theme_bw() +
  theme(legend.position = "none") +
  facet_wrap( ~ Igroup)

fpar.plot

# save the plot 
ggsave("fpar_plot.png", fpar.plot, width = 5, height = 3)
```

```{r lai}
# lai
lai.plot <- ssf_coefs %>% filter(!is.na(estimate)) %>%
  filter(term %in% c("lai")) %>% 
  ggplot(., aes(x = term, y = estimate, fill = Igroup))+
  geom_boxplot()+
  geom_jitter(shape = 16, position = position_jitter(0.2))+
  geom_hline(yintercept = 0)+
  scale_x_discrete(labels = c("")) +
  ylab("Coefficient estimate") +
  xlab("")+
  ggtitle("Leaf area index (lai)")+
  theme_bw() +
  theme(legend.position = "none") +
  facet_wrap( ~ Igroup)

lai.plot

# save the plot 
ggsave("LAI_plot.png", lai.plot, width = 5, height = 3)
```

```{r GPP}
# GPP
gpp.plot <- ssf_coefs %>% filter(!is.na(estimate)) %>%
  filter(term %in% c("GPP")) %>% 
  ggplot(., aes(x = term, y = estimate, fill = Igroup))+
  geom_boxplot()+
  geom_jitter(shape = 16, position = position_jitter(0.2))+
  geom_hline(yintercept = 0)+
  scale_x_discrete(labels = c("")) +
  ylab("Coefficient estimate") +
  xlab("")+
  ggtitle("Gross Primary Production (GPP)")+
  theme_bw() +
  theme(legend.position = "none") +
  facet_wrap( ~ Igroup)

gpp.plot

# save the plot 
ggsave("GPP_plot.png", gpp.plot, width = 5, height = 3)
```

```{r shrub}
# shrub
shrub.plot <- ssf_coefs %>% filter(!is.na(estimate)) %>%
  filter(term %in% c("final.shrub")) %>%
  ggplot(., aes(x = term, y = estimate, fill = Igroup)) +
  geom_boxplot() +
  geom_jitter(shape = 16, position = position_jitter(0.2)) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_x_discrete(labels = c("")) +
  ylab("Coefficient estimate") +
  xlab("")+
  ggtitle("Use of Woody Vegetation")+
  theme_bw() +
  theme(legend.position = "none") +
  facet_wrap( ~ Igroup)

shrub.plot

# save the plot 
ggsave("shrub_plot.png", shrub.plot, width = 5, height = 3)
```
# Ineraction terms

shrub:BC
```{r shrub coeff mod}
# shrub interaction coeffs
final.shrub.int.ceoffs <- ssf_coefs %>% filter(!is.na(estimate)) %>% 
  filter(term %in% c("final.shrub:c_avg_BCover","final.shrub:c_avg_BCunder"))

final.shrub.int.ceoffs$term <- factor(final.shrub.int.ceoffs$term, levels = c("final.shrub:c_avg_BCunder", "final.shrub:c_avg_BCover"))  

final.shrub.int.ceoffs <- final.shrub.int.ceoffs %>% mutate(Igroup = ifelse(Igroup == "Susceptible", "Non_Infected", Igroup))

final.shrub.int.ceoffs <- final.shrub.int.ceoffs %>% dplyr::filter(!is.na(p.value))

final.shrub.int.ceoffs %>% filter(p.value < 0.05)

# mean shrub interaction coeffs 

## Infected
Infect.shrub.int.coeffs <- final.shrub.int.ceoffs %>% dplyr::filter(Igroup == "Infected")
Infect.shrub.int.coeffs <- Infect.shrub.int.coeffs %>% mutate(mean_estimate = mean(Infect.shrub.int.coeffs$estimate),
                                   mean_std.error = mean(Infect.shrub.int.coeffs$std.error))

Infect.shrub.int.coeffs

## Non-Infected
Non_Infect.shrub.int.coeffs <- final.shrub.int.ceoffs %>% dplyr::filter(Igroup == "Non_Infected")
Non_Infect.shrub.int.coeffs <- Non_Infect.shrub.int.coeffs %>% mutate(mean_estimate = mean(Non_Infect.shrub.int.coeffs$estimate),
                                   mean_std.error = mean(Non_Infect.shrub.int.coeffs$std.error))

Non_Infect.shrub.int.coeffs

# rbind 
mean_coeffs <- rbind(Infect.shrub.int.coeffs, Non_Infect.shrub.int.coeffs)

# filter out the na p values
mean_coeffs 
```

```{r shrub interaction}
# shrub:avg BC
shrub_int <- ggplot(final.shrub.int.ceoffs, aes(x = term, y = estimate, fill = term)) +
  geom_boxplot() +
  geom_jitter(shape = 16, position = position_jitter(0.2)) +
  geom_point(
    data = mean_coeffs,
    aes(x = term, y = mean_estimate),
    col = "#0072B2",
    shape = 15,
    size = 2
  ) +
  geom_linerange(
    data = mean_coeffs,
    aes(
      x = term,
      ymin = mean_estimate - 1.96 * mean_std.error,
      ymax = mean_estimate + 1.96 * mean_std.error
    ),
    col = "#0072B2",
    size = 1.2
  ) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_fill_manual(values = c("#CC79A7", "#E69F00")) +
  scale_x_discrete(labels = c("Under", "Over")) +
  ylab("Coefficient estimate") +
  xlab("") +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(size = 12)) +
  facet_wrap( ~ Igroup)

shrub_int

# save the plot 
#ggsave("shrub_int_plot.png", shrub_int, width = 5, height = 3)
```
Infected oryx selected for shade offered by woody vegetation more strongly than susceptible oryx, indicating that infected oryx showed stronger preferences for shade areas (i.e., resting behaviors).



NDVI:BC
```{r NDVI int coeff mod}
# NDVI:avg BC
NDVI.int.ceoffs <- ssf_coefs %>% filter(!is.na(estimate)) %>% 
  filter(term %in% c("NDVI:c_avg_BCover","NDVI:c_avg_BCunder"))

NDVI.int.ceoffs$term <- factor(NDVI.int.ceoffs$term, levels = c("NDVI:c_avg_BCunder", "NDVI:c_avg_BCover"))  

NDVI.int.ceoffs <- NDVI.int.ceoffs %>% mutate(Igroup = ifelse(Igroup == "Susceptible", "Non_Infected", Igroup))

NDVI.int.ceoffs <- NDVI.int.ceoffs %>% dplyr::filter(!is.na(p.value))
NDVI.int.ceoffs %>% filter(p.value < 0.05)

# mean shrub interaction coeffs 

## Infected
Infect.NDVI.int.coeffs <- NDVI.int.ceoffs %>% dplyr::filter(Igroup == "Infected")
Infect.NDVI.int.coeffs <- Infect.NDVI.int.coeffs %>% mutate(mean_estimate = mean(Infect.NDVI.int.coeffs$estimate),
                                   mean_std.error = mean(Infect.NDVI.int.coeffs$std.error))

Infect.NDVI.int.coeffs

## Non-Infected
Non_Infect.NDVI.int.coeffs <- NDVI.int.ceoffs %>% dplyr::filter(Igroup == "Non_Infected")
Non_Infect.NDVI.int.coeffs <- Non_Infect.NDVI.int.coeffs %>% mutate(mean_estimate = mean(Non_Infect.NDVI.int.coeffs$estimate),
                                   mean_std.error = mean(Non_Infect.NDVI.int.coeffs$std.error))

Non_Infect.NDVI.int.coeffs

# rbind 
mean_NDVI_coeffs <- rbind(Infect.NDVI.int.coeffs, Non_Infect.NDVI.int.coeffs)
mean_NDVI_coeffs
``` 

```{r NDVI interaction} 
NDVI_int <- NDVI.int.ceoffs %>%
  ggplot(., aes(x = term, y = estimate, fill = term)) +
  geom_boxplot() +
  geom_jitter(shape = 16, position = position_jitter(0.2)) +
  geom_point(
    data = mean_NDVI_coeffs,
    aes(x = term, y = mean_estimate),
    col = "#0072B2",
    shape = 15,
    size = 2
  ) +
  geom_linerange(
    data = mean_NDVI_coeffs,
    aes(
      x = term,
      ymin = mean_estimate - 1.96 * mean_std.error,
      ymax = mean_estimate + 1.96 * mean_std.error
    ),
    col = "#0072B2",
    size = 1.2
  ) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_fill_manual(values = c("#CC79A7", "#E69F00")) +
  scale_x_discrete(labels = c("Under", "Over")) +
  ylab("") +
  xlab("") +
  ggtitle("(b) NDVI x Body Conditions") +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(size = 10)) +
  facet_wrap(~ Igroup)

NDVI_int

# save the plot 
ggsave("NDVI_int_plot.png", NDVI_int, width = 5, height = 3)
```

fPAR:BC
```{r FPAR int coeff mod}
# FPAR:avg BC
fpar.int.ceoffs <- ssf_coefs %>% filter(!is.na(estimate)) %>% 
  filter(term %in% c("fpar:c_avg_BCover","fpar:c_avg_BCunder"))

fpar.int.ceoffs$term <- factor(fpar.int.ceoffs$term, levels = c("fpar:c_avg_BCunder", "fpar:c_avg_BCover"))  

fpar.int.ceoffs <- fpar.int.ceoffs %>% mutate(Igroup = ifelse(Igroup == "Susceptible", "Non_Infected", Igroup))

fpar.int.ceoffs <- fpar.int.ceoffs %>% dplyr::filter(!is.na(p.value))

fpar.int.ceoffs %>% filter(p.value < 0.05)

# mean shrub interaction coeffs 

## Infected
Infect.fpar.int.coeffs <- fpar.int.ceoffs %>% dplyr::filter(Igroup == "Infected")
Infect.fpar.int.coeffs <- Infect.fpar.int.coeffs %>% mutate(mean_estimate = mean(Infect.fpar.int.coeffs$estimate),
                                   mean_std.error = mean(Infect.fpar.int.coeffs$std.error))

Infect.fpar.int.coeffs

## Non-Infected
Non_Infect.fpar.int.coeffs <- fpar.int.ceoffs %>% dplyr::filter(Igroup == "Non_Infected")
Non_Infect.fpar.int.coeffs <- Non_Infect.fpar.int.coeffs %>% mutate(mean_estimate = mean(Non_Infect.fpar.int.coeffs$estimate),
                                   mean_std.error = mean(Non_Infect.fpar.int.coeffs$std.error))

Non_Infect.fpar.int.coeffs

# rbind 
mean_fpar_coeffs <- rbind(Infect.fpar.int.coeffs, Non_Infect.fpar.int.coeffs)
mean_fpar_coeffs
``` 

```{r FPAR interaction} 
fpar_int <- fpar.int.ceoffs %>%
  ggplot(., aes(x = term, y = estimate, fill = term)) +
  geom_boxplot() +
  geom_jitter(shape = 16, position = position_jitter(0.2)) +
  geom_point(
    data = mean_fpar_coeffs,
    aes(x = term, y = mean_estimate),
    col = "#0072B2",
    shape = 15,
    size = 2
  ) +
  geom_linerange(
    data = mean_fpar_coeffs,
    aes(
      x = term,
      ymin = mean_estimate - 1.96 * mean_std.error,
      ymax = mean_estimate + 1.96 * mean_std.error
    ),
    col = "#0072B2",
    size = 1.2
  ) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_fill_manual(values = c("#CC79A7", "#E69F00")) +
  scale_x_discrete(labels = c("Under", "Over")) +
  ylab("") +
  xlab("") +
  ggtitle("(b) fPAR x Body Conditions") +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(size = 10)) +
  facet_wrap(~ Igroup)

fpar_int

# save the plot 
ggsave("fpar_int_plot.png", fpar_int, width = 5, height = 3)
```

temp:BC
```{r temp int coeff mod}
# temp:avg BC
temp.int.ceoffs <- ssf_coefs %>% filter(!is.na(estimate)) %>% 
  filter(term %in% c("temp_c:c_avg_BCover","temp_c:c_avg_BCunder"))

temp.int.ceoffs$term <- factor(temp.int.ceoffs$term, levels = c("temp_c:c_avg_BCunder", "temp_c:c_avg_BCover"))  

temp.int.ceoffs <- temp.int.ceoffs %>% mutate(Igroup = ifelse(Igroup == "Susceptible", "Non_Infected", Igroup))

temp.int.ceoffs <- temp.int.ceoffs %>% dplyr::filter(!is.na(p.value))

temp.int.ceoffs %>% filter(p.value < 0.05)

# mean shrub interaction coeffs 

## Infected
Infect.temp.int.coeffs <- temp.int.ceoffs %>% dplyr::filter(Igroup == "Infected")
Infect.temp.int.coeffs <- Infect.temp.int.coeffs %>% mutate(mean_estimate = mean(Infect.temp.int.coeffs$estimate),
                                   mean_std.error = mean(Infect.temp.int.coeffs$std.error))

Infect.temp.int.coeffs

## Non-Infected
Non_Infect.temp.int.coeffs <- temp.int.ceoffs %>% dplyr::filter(Igroup == "Non_Infected")
Non_Infect.temp.int.coeffs <- Non_Infect.temp.int.coeffs %>% mutate(mean_estimate = mean(Non_Infect.temp.int.coeffs$estimate),
                                   mean_std.error = mean(Non_Infect.temp.int.coeffs$std.error))

Non_Infect.temp.int.coeffs

# rbind 
mean_temp_coeffs <- rbind(Infect.temp.int.coeffs, Non_Infect.temp.int.coeffs)
mean_temp_coeffs
``` 

```{r temp interaction} 
temp_int <- temp.int.ceoffs %>%
  ggplot(., aes(x = term, y = estimate, fill = term)) +
  geom_boxplot() +
  geom_jitter(shape = 16, position = position_jitter(0.2)) +
  geom_point(
    data = mean_temp_coeffs,
    aes(x = term, y = mean_estimate),
    col = "#0072B2",
    shape = 15,
    size = 2
  ) +
  geom_linerange(
    data = mean_temp_coeffs,
    aes(
      x = term,
      ymin = mean_estimate - 1.96 * mean_std.error,
      ymax = mean_estimate + 1.96 * mean_std.error
    ),
    col = "#0072B2",
    size = 1.2
  ) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_fill_manual(values = c("#CC79A7", "#E69F00")) +
  scale_x_discrete(labels = c("Under", "Over")) +
  ylab("") +
  xlab("") +
  ggtitle("(b) temp x Body Conditions") +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(size = 10)) +
  facet_wrap(~ Igroup)

temp_int

# save the plot 
ggsave("temp_int_plot.png", temp_int, width = 5, height = 3)
```

lai:BC
```{r GPP}
# lai:avg BC
lai.int.ceoffs <- ssf_coefs %>% filter(!is.na(estimate)) %>% 
  filter(term %in% c("lai:c_avg_BCover","lai:c_avg_BCunder"))

lai.int.ceoffs$term <- factor(lai.int.ceoffs$term, levels = c("lai:c_avg_BCunder", "lai:c_avg_BCover"))  

lai_int <- lai.int.ceoffs %>% 
  ggplot(., aes(x = term, y = estimate, fill = term))+
  geom_boxplot()+
  geom_jitter(shape = 16, position = position_jitter(0.2))+
  geom_hline(yintercept = 0, linetype = 2)+
  scale_fill_manual(values = c("tomato", "#56B4E9"))+
  scale_x_discrete(labels = c("Under", "Over"))+
  ylab("Coefficient estimate")+
  xlab("")+
  ggtitle("laierature x Body Conditions")+
  theme_bw()+
  theme(legend.position = "none")+
  facet_wrap(~Igroup)

lai_int

# save the plot 
ggsave("lai_int_plot.png", lai_int, width = 5, height = 3)
```

GPP:BC
```{r GPP}
# GPP:avg BC
GPP.int.ceoffs <- ssf_coefs %>% filter(!is.na(estimate)) %>% 
  filter(term %in% c("GPP:c_avg_BCover","GPP:c_avg_BCunder"))

GPP.int.ceoffs$term <- factor(GPP.int.ceoffs$term, levels = c("GPP:c_avg_BCunder", "GPP:c_avg_BCover"))  

GPP_int <- GPP.int.ceoffs %>% 
  ggplot(., aes(x = term, y = estimate, fill = term))+
  geom_boxplot()+
  geom_jitter(shape = 16, position = position_jitter(0.2))+
  geom_hline(yintercept = 0, linetype = 2)+
  scale_fill_manual(values = c("tomato", "#56B4E9"))+
  scale_x_discrete(labels = c("Under", "Over"))+
  ylab("Coefficient estimate")+
  xlab("")+
  ggtitle("GPPerature x Body Conditions")+
  theme_bw()+
  theme(legend.position = "none")+
  facet_wrap(~Igroup)

GPP_int

# save the plot 
ggsave("GPP_int_plot.png", GPP_int, width = 5, height = 3)
```

combine the plots 
```{r combine the plots}
# combine the figures 
grid <- plot_grid(shrub_int, fpar_int, ncol = 2, rel_heights = c(1/4, 1/6))


#grid <- grid.arrange(fig.a, fig.b, fig.c, nrow = 3, ncol = 1)

grid
```

save the used landcover plot 
```{r save the plot}
ggsave("fig3.png", grid, width = 7, height = 2.5, dpi = 400, bg = NA)
```

# Footer
```{r footer}
sessionInfo()
```