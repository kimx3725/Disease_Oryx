---
title: "2a.Ndeath_data_prep1"
author: "Dennis Kim"
date: "2023-12-05"
output: html_document
---

# Objective 

To manipulate the merged tracking data with the other addtional columns for SSFs. To do this, I will: 

1. Determine infected individuals and healthy individuals    
3=2. Inspect movement characteristics of individuals 

# Document Preamble 
```{r preamble, message=FALSE, warning=FALSE}
# load libraries
library(knitr)
library(dplyr)
library(readr)
library(data.table)
library(DT)
library(here)
library(stringr)
library(tidyr)
library(purrr)
library(lubridate)

# call environmental data
library(terra)

# analysis
library(hmmSSF)

# visualization 
library(ggplot2)

options(width = 150)

# set knitr options 
opts_chunk$set(fig.width = 6, fig.height = 5, comment = NA)
```

# 1. Data preparation

## 1.1. Format of tracking data

Read in the gps data
```{r read in data}
# Location data of the oryx with additional disease columns 
oryx <- read.csv(here::here("data", "oryx_gps_id.csv"))

# NAs in fate column convert to unkown
oryx$fate[is.na(oryx$fate)] <- "unknown"

# summary of the location data 
summary(oryx)

# select individuals that contain the dataset between mid August and early November in 2018 - other than release group 4: 5 individuals 
oryx_no_Rgroup4 <- oryx %>% filter(Rgroup %in% c(1, 2, 3)) %>% filter(date > "2018-08-01 00:00:00" & cause_of_death %in% c("disease", "presumed disease", "unknown")) %>% distinct(masterID, Rgroup, cause_of_death)
```

Referenced by Katherine Mertes -- select healthy and infected individuals within the same release group (R4)
```{r indicators}
# R4: infected & unknown individuals: 39 individuals - 500m filter
R4_disease <- oryx %>% filter(Rgroup == 4) %>% filter(cause_of_death %in% c("disease", "presumed disease", "unknown")) %>% nest_by(masterID) %>% mutate(rows = nrow(data)) %>% dplyr::select(-data) %>% filter(rows > 100)
R4_disease
write.csv(R4_disease, "R4_disease.csv")

# R4: non-infected alive individuals: 28 individuals 
R4_Ndisease <- oryx %>% filter(Rgroup == 4) %>% filter(cause_of_death %in% "alive") %>% nest_by(masterID) %>% mutate(rows = nrow(data)) %>% dplyr::select(-data) 
R4_Ndisease
write.csv(R4_Ndisease, "R4_Ndisease.csv")

# Other R groups: 5 individuals with unknown, disease information 
oryx %>% filter(masterID %in% oryx_no_Rgroup4$masterID) %>% group_by(masterID) %>% slice_tail(n=1)
no_R4_disease <- oryx %>% filter(masterID %in% oryx_no_Rgroup4$masterID) %>% nest_by(masterID) %>% mutate(rows = nrow(data)) %>% dplyr::select(-data) 
no_R4_disease
write.csv(no_R4_disease, "no_R4_disease.csv")

# check if the body condition data are available
## read the body condition data 
#body_condition <- read.csv(here::here("data", "oryx_individual_field_data_122322.csv"))

# only select the columns that are applicable to the data 
#body_condition <- body_condition %>% dplyr::select(datetime, animalID, lat, long, body_condition)

# filter the data with non-NAs for body condition values 
#body_condition <- body_condition[complete.cases(body_condition[, 5]),]

# check the available body condition individuals based on Rgroup 
#body_condition_id <- body_condition %>% nest_by(animalID) %>% mutate(rows = nrow(data)) %>% dplyr::select(-data) %>% 
#  mutate(group = case_when(
#    animalID %in% R4_disease$masterID ~ "Infected",
#    animalID %in% no_R4_disease$masterID ~ "Unknown",
#    animalID %in% R4_Ndisease$masterID ~ "Susceptible"
#  )) %>% 
#  na.omit()

#body_condition_id 

#list of the selected individuals 
all_list <- rbind(R4_disease, R4_Ndisease, no_R4_disease)
all_list
```

```{r select individuals}
# select R4 group that has the body condition data (52 individuals)
multiple_oryx <-
  oryx %>% filter(
    masterID %in% all_list$masterID
  )

# remove the original data to reduce the memory capacity 
#rm(oryx)
rm(R4_disease)
rm(no_R4_disease)
rm(R4_Ndisease)
#rm(body_condition_id)

# change the time format of the data 
multiple_oryx$date <- multiple_oryx$date <- as.POSIXct(multiple_oryx$date, format = "%Y-%m-%d %H:%M:%S")
multiple_oryx$date_collared <- multiple_oryx$date_collared %>% mdy()
multiple_oryx$date_released <- multiple_oryx$date_released %>% mdy()

# get rid of any missing location values in long, lat, and timestamp 
filter_ids <- multiple_oryx %>% dplyr::select("long", "lat", "date") %>% complete.cases
multiple_oryx <- multiple_oryx %>% filter(., filter_ids == TRUE)

# filter unreasonable dataset
#multiple_oryx <- multiple_oryx %>% filter(!masterID %in% c("R08M", "R85M"))

multiple_oryx %>% distinct(masterID)
```

add seasonal info 
```{r seasons}
# create an indicator column that label the different seasonal ranges
multiple_oryx <- multiple_oryx %>%
  mutate(
    week = week(date),
    day_of_year = yday(date),
    season_level = case_when(
      dplyr::between(day_of_year, 72, 191) ~ 'hotdry',
      dplyr::between(day_of_year, 192, 274) ~
        'rainy'
    )
  ) %>%
  mutate(season_level = replace_na(season_level, "cooldry")) %>%
  ungroup()

multiple_oryx %>% summary()

oryx_df <- multiple_oryx
```

filter the body condition data for the selected individuals and join the data 
```{r Bc}
# change the column name of the body condition same as the original tracking data 
#colnames(body_condition) <- c("date", "masterID", "lat", "long", "body_condition")

# select the healthy individuals for our cases 
#BC <-
#  body_condition %>% filter(
#    masterID %in% body_condition_id$animalID
#  )

# create julian dates and week id for the BC data
#BC <- BC %>%
#  mutate(julian = yday(date),
#         week = week(date)) 

# calculate the average body condition value based on each duplicated week
#average.week.BC <- BC %>% group_by(masterID, week) %>% 
#  mutate(avg.bc = mean(body_condition)) %>% 
#  dplyr::select(week, avg.bc) %>% 
#  distinct()

# join the data
#multiple_oryx2 <- multiple_oryx %>% left_join(average.week.BC, by = c("masterID", "week"))
#multiple_oryx2 %>% na.omit(.)

# only select complete data with body condition
#oryx_df <- multiple_oryx2 %>% filter(!is.na(avg.bc)) %>% 
#  mutate(c_avg_BC = ifelse(avg.bc < 4, "under", ifelse(avg.bc < 7, "optimal", "over")) %>% as.factor(.))

#oryx_df %>% summary()
```

further data cleaning 
```{r data cleaning}
# re-level body conditions and Igroup
#oryx_df <- oryx_df %>% mutate(c_avg_BC = factor(c_avg_BC, level = c("under", "optimal", "over"))) 
oryx_df <- oryx_df %>% mutate(cause_of_death = factor(cause_of_death))

# change the name of the cause of the disease 
oryx_df <- oryx_df %>% mutate(cause_of_death = ifelse(cause_of_death == "alive", "Non-infected", 
                                              ifelse(cause_of_death == "presumed disease", "Unknown",
                                                     "Infected")))

# relevel the cause of disease factors
oryx_df <- oryx_df %>% mutate(cause_of_death = factor(cause_of_death, level = c("Non-infected", "Unknown", "Infected")))
oryx_df %>% filter(cause_of_death == "Infected") %>% distinct(masterID)

# add numerical variable for animal IDs
oryx_df$num_id <- match(oryx_df$masterID, unique(oryx_df$masterID))

# add numerical variable for animals 
oryx_df$num_id <- as.numeric(oryx_df$num_id)

# total 72 individuals
oryx_df %>% distinct(masterID)

# save the prepared dataset for HMM_SSF
#readr::write_rds(oryx_df, path = here("data/filtered_dataset", "oryx_trk.Rdata"))
```

# Footer
```{r footer}
sessionInfo()
```